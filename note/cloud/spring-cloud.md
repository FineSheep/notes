# è®¤è¯†å¾®æœåŠ¡
## å•ä½“æ¶æ„
**å•ä½“æ¶æ„**ï¼šå°†ä¸šåŠ¡çš„æ‰€æœ‰åŠŸèƒ½é›†ä¸­åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­å¼€å‘ï¼Œæ‰“æˆä¸€ä¸ªåŒ…éƒ¨ç½²ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561681306-389df405-81b2-4852-81da-2f61ef78388b.png#averageHue=%23f9f2f1&clientId=ue42b8c5c-255d-4&from=paste&id=u9fff84d0&originHeight=416&originWidth=1203&originalType=url&ratio=1&rotation=0&showTitle=false&size=53109&status=done&style=none&taskId=u1ddcf18c-60ef-4f29-80f8-69f9a514028&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901083809.png)
**ä¼˜ç‚¹ï¼š**æ¶æ„ç®€å•ï¼Œéƒ¨ç½²æˆæœ¬ä½
**ç¼ºç‚¹ï¼š**è€¦åˆåº¦é«˜ï¼ˆç»´æŠ¤å›°éš¾ã€å‡çº§å›°éš¾ï¼‰

## åˆ†å¸ƒå¼æ¶æ„
**åˆ†å¸ƒå¼æ¶æ„**ï¼šæ ¹æ®ä¸šåŠ¡åŠŸèƒ½å¯¹ç³»ç»Ÿåšæ‹†åˆ†ï¼Œæ¯ä¸ªä¸šåŠ¡åŠŸèƒ½æ¨¡å—ä½œä¸ºç‹¬ç«‹é¡¹ç›®å¼€å‘ï¼Œç§°ä¸ºä¸€ä¸ªæœåŠ¡ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561685777-fcfc0986-c92a-4e91-af70-d7210ebb0daf.png#averageHue=%23f9f6f5&clientId=ue42b8c5c-255d-4&from=paste&id=ucecb63a7&originHeight=701&originWidth=1370&originalType=url&ratio=1&rotation=0&showTitle=false&size=145442&status=done&style=none&taskId=ue8447fc7-559d-48b9-a269-93d626d832e&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092921.png)
**ä¼˜ç‚¹ï¼š**é™ä½æœåŠ¡è€¦åˆï¼Œæœ‰åˆ©äºæœåŠ¡å‡çº§å’Œæ‹“å±•
**ç¼ºç‚¹ï¼š**æœåŠ¡è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚
åˆ†å¸ƒå¼æ¶æ„è™½ç„¶é™ä½äº†æœåŠ¡è€¦åˆï¼Œä½†æ˜¯æœåŠ¡æ‹†åˆ†æ—¶ä¹Ÿæœ‰å¾ˆå¤šé—®é¢˜éœ€è¦æ€è€ƒï¼š

- æœåŠ¡æ‹†åˆ†çš„ç²’åº¦å¦‚ä½•ç•Œå®šï¼Ÿ
- æœåŠ¡ä¹‹é—´å¦‚ä½•è°ƒç”¨ï¼Ÿ
- æœåŠ¡çš„è°ƒç”¨å…³ç³»å¦‚ä½•ç®¡ç†ï¼Ÿ

**äººä»¬éœ€è¦åˆ¶å®šä¸€å¥—è¡Œä¹‹æœ‰æ•ˆçš„æ ‡å‡†æ¥çº¦æŸåˆ†å¸ƒå¼æ¶æ„ã€‚**
## å¾®æœåŠ¡
å¾®æœåŠ¡çš„æ¶æ„ç‰¹å¾ï¼š

- å•ä¸€èŒè´£ï¼šå¾®æœåŠ¡æ‹†åˆ†ç²’åº¦æ›´å°ï¼Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½å¯¹åº”å”¯ä¸€çš„ä¸šåŠ¡èƒ½åŠ›ï¼Œåšåˆ°å•ä¸€èŒè´£
- è‡ªæ²»ï¼šå›¢é˜Ÿç‹¬ç«‹ã€æŠ€æœ¯ç‹¬ç«‹ã€æ•°æ®ç‹¬ç«‹ï¼Œç‹¬ç«‹éƒ¨ç½²å’Œäº¤ä»˜
- é¢å‘æœåŠ¡ï¼šæœåŠ¡æä¾›ç»Ÿä¸€æ ‡å‡†çš„æ¥å£ï¼Œä¸è¯­è¨€å’ŒæŠ€æœ¯æ— å…³
- éš”ç¦»æ€§å¼ºï¼šæœåŠ¡è°ƒç”¨åšå¥½éš”ç¦»ã€å®¹é”™ã€é™çº§ï¼Œé¿å…å‡ºç°çº§è”é—®é¢˜

[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561681871-d6b1860e-8138-4c35-b0c6-841d8b41c2ae.png#averageHue=%23f8f3f1&clientId=ue42b8c5c-255d-4&from=paste&id=u08cc97e4&originHeight=355&originWidth=1000&originalType=url&ratio=1&rotation=0&showTitle=false&size=150652&status=done&style=none&taskId=u3d68d3d5-a4fa-4a0f-b0d9-8118ee930e9&title=)](https://cdn.xn2001.com/blog/img20210901083658.png)
å¾®æœåŠ¡çš„ä¸Šè¿°ç‰¹æ€§**å…¶å®æ˜¯åœ¨ç»™åˆ†å¸ƒå¼æ¶æ„åˆ¶å®šä¸€ä¸ªæ ‡å‡†**ï¼Œè¿›ä¸€æ­¥é™ä½æœåŠ¡ä¹‹é—´çš„è€¦åˆåº¦ï¼Œæä¾›æœåŠ¡çš„ç‹¬ç«‹æ€§å’Œçµæ´»æ€§ã€‚åšåˆ°é«˜å†…èšï¼Œä½è€¦åˆã€‚
**å› æ­¤ï¼Œå¯ä»¥è®¤ä¸ºå¾®æœåŠ¡æ˜¯ä¸€ç§ç»è¿‡è‰¯å¥½æ¶æ„è®¾è®¡çš„åˆ†å¸ƒå¼æ¶æ„æ–¹æ¡ˆ ã€‚**
å…¶ä¸­åœ¨ Java é¢†åŸŸæœ€å¼•äººæ³¨ç›®çš„å°±æ˜¯ SpringCloud æä¾›çš„æ–¹æ¡ˆäº†ã€‚
## SpringCloud
SpringCloud æ˜¯ç›®å‰å›½å†…ä½¿ç”¨æœ€å¹¿æ³›çš„å¾®æœåŠ¡æ¡†æ¶ã€‚å®˜ç½‘åœ°å€ï¼š[https://spring.io/projects/spring-cloud](https://spring.io/projects/spring-cloud)ã€‚
SpringCloud é›†æˆäº†å„ç§å¾®æœåŠ¡åŠŸèƒ½ç»„ä»¶ï¼Œå¹¶åŸºäº SpringBoot å®ç°äº†è¿™äº›ç»„ä»¶çš„è‡ªåŠ¨è£…é…ï¼Œä»è€Œæä¾›äº†è‰¯å¥½çš„å¼€ç®±å³ç”¨ä½“éªŒã€‚
å…¶ä¸­å¸¸è§çš„ç»„ä»¶åŒ…æ‹¬ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561681943-8822dfda-da99-4535-ad37-92f63bd24c43.png#averageHue=%23f4f0ef&clientId=ue42b8c5c-255d-4&from=paste&id=ucde9886c&originHeight=573&originWidth=1332&originalType=url&ratio=1&rotation=0&showTitle=false&size=93585&status=done&style=none&taskId=ueff9f50d-c964-40ae-a14e-8c01f06046d&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901083717.png)
å¦å¤–ï¼ŒSpringCloud åº•å±‚æ˜¯ä¾èµ–äº SpringBoot çš„ï¼Œå¹¶ä¸”æœ‰ç‰ˆæœ¬çš„å…¼å®¹å…³ç³»ï¼Œå¦‚ä¸‹ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561681788-5017c43a-8e64-4a3c-835b-cf7669d1ab3a.png#averageHue=%23fefefd&clientId=ue42b8c5c-255d-4&from=paste&id=u8d4eaef5&originHeight=362&originWidth=885&originalType=url&ratio=1&rotation=0&showTitle=false&size=52387&status=done&style=none&taskId=ue9e159c1-2c34-4bf3-b733-1999a93328c&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901084050.png)
## å†…å®¹çŸ¥è¯†
éœ€è¦å­¦ä¹ çš„å¾®æœåŠ¡çŸ¥è¯†å†…å®¹
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561685498-5ea73829-9787-41ed-ab52-8f94250b0cd7.png#averageHue=%23cdcfaa&clientId=ue42b8c5c-255d-4&from=paste&id=u79a74ad8&originHeight=916&originWidth=1462&originalType=url&ratio=1&rotation=0&showTitle=false&size=297039&status=done&style=none&taskId=u5d519c95-73f9-461f-918e-da0290e62c9&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092925.png)
æŠ€æœ¯æ ˆ
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561688231-4fb44cb9-2103-4510-9066-3e044ee0076a.png#averageHue=%23fbf9f9&clientId=ue42b8c5c-255d-4&from=paste&id=u3d45c96f&originHeight=1080&originWidth=1920&originalType=url&ratio=1&rotation=0&showTitle=false&size=220834&status=done&style=none&taskId=ue5b0ced4-6218-497b-bfe4-292ebc1d443&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901084131.png)
è‡ªåŠ¨åŒ–éƒ¨ç½²
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561683999-786bcdf3-67ec-436a-98f3-626a021555fb.png#averageHue=%23fcf4ed&clientId=ue42b8c5c-255d-4&from=paste&id=u62d2d046&originHeight=468&originWidth=645&originalType=url&ratio=1&rotation=0&showTitle=false&size=38135&status=done&style=none&taskId=u4cc5345f-3b0d-4145-a47b-2b23d367b86&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901090737.png)
## æŠ€æœ¯æ ˆå¯¹æ¯”
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561686183-e0186628-e8fe-47d0-922c-3869be13b8c1.png#averageHue=%23d1bcbb&clientId=ue42b8c5c-255d-4&from=paste&id=u2e053966&originHeight=625&originWidth=1751&originalType=url&ratio=1&rotation=0&showTitle=false&size=92883&status=done&style=none&taskId=ue50e13b6-0231-4719-ba2c-daee0f90d85&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901090726.png)
# æœåŠ¡æ‹†åˆ†
æ¡ˆä¾‹æºç ï¼š[https://gitee.com/xn2001/cloudcode/tree/master/01-cloud-demo](https://gitee.com/xn2001/cloudcode/tree/master/01-cloud-demo)
**æœåŠ¡æ‹†åˆ†æ³¨æ„äº‹é¡¹**
å•ä¸€èŒè´£ï¼šä¸åŒå¾®æœåŠ¡ï¼Œä¸è¦é‡å¤å¼€å‘ç›¸åŒä¸šåŠ¡
æ•°æ®ç‹¬ç«‹ï¼šä¸è¦è®¿é—®å…¶å®ƒå¾®æœåŠ¡çš„æ•°æ®åº“
é¢å‘æœåŠ¡ï¼šå°†è‡ªå·±çš„ä¸šåŠ¡æš´éœ²ä¸ºæ¥å£ï¼Œä¾›å…¶å®ƒå¾®æœåŠ¡è°ƒç”¨
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561701543-bfe65c9c-0aaf-4336-8687-c025044d0ffc.png#averageHue=%23f5f2ee&clientId=ue42b8c5c-255d-4&from=paste&id=ufc2d0ae1&originHeight=384&originWidth=427&originalType=url&ratio=1&rotation=0&showTitle=false&size=29530&status=done&style=none&taskId=u84b103f6-447f-47a0-9bdd-c68ae48f97e&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901090745.png)
cloud-demoï¼šçˆ¶å·¥ç¨‹ï¼Œç®¡ç†ä¾èµ–

- order-serviceï¼šè®¢å•å¾®æœåŠ¡ï¼Œè´Ÿè´£è®¢å•ç›¸å…³ä¸šåŠ¡
- user-serviceï¼šç”¨æˆ·å¾®æœåŠ¡ï¼Œè´Ÿè´£ç”¨æˆ·ç›¸å…³ä¸šåŠ¡

è¦æ±‚ï¼š

- è®¢å•å¾®æœåŠ¡å’Œç”¨æˆ·å¾®æœåŠ¡éƒ½å¿…é¡»æœ‰**å„è‡ªçš„æ•°æ®åº“**ï¼Œç›¸äº’ç‹¬ç«‹
- è®¢å•æœåŠ¡å’Œç”¨æˆ·æœåŠ¡**éƒ½å¯¹å¤–æš´éœ² Restful çš„æ¥å£**
- è®¢å•æœåŠ¡å¦‚æœéœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œ**åªèƒ½è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„ Restful æ¥å£**ï¼Œä¸èƒ½æŸ¥è¯¢ç”¨æˆ·æ•°æ®åº“

å¾®æœåŠ¡é¡¹ç›®ä¸‹ï¼Œæ‰“å¼€ idea ä¸­çš„ Serviceï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯åŠ¨ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561706213-12f756e7-86bf-416a-8cd0-7f78d9cf149b.png#averageHue=%23eef2eb&clientId=ue42b8c5c-255d-4&from=paste&id=u0c82d417&originHeight=397&originWidth=1031&originalType=url&ratio=1&rotation=0&showTitle=false&size=77098&status=done&style=none&taskId=ua05392f6-68dd-4b69-86a0-1f49d7a7fdc&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901090750.png)
å¯åŠ¨å®Œæˆåï¼Œè®¿é—® [http://localhost:8080/order/101](http://localhost:8080/order/101)
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561704309-fd6aff7f-096c-4db5-95bd-1abe724e2ae5.png#averageHue=%23fefefd&clientId=ue42b8c5c-255d-4&from=paste&id=u7291e3b6&originHeight=320&originWidth=528&originalType=url&ratio=1&rotation=0&showTitle=false&size=20297&status=done&style=none&taskId=uf0db37f6-405c-4156-87b6-5feffee9f6d&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901090757.png)
# è¿œç¨‹è°ƒç”¨
æ¡ˆä¾‹æºç ï¼š[https://gitee.com/xn2001/cloudcode/tree/master/02-cloud-restTemplate](https://gitee.com/xn2001/cloudcode/tree/master/02-cloud-restTemplate)
æ­£å¦‚ä¸Šé¢çš„æœåŠ¡æ‹†åˆ†è¦æ±‚ä¸­æ‰€æåˆ°ï¼Œ
è®¢å•æœåŠ¡å¦‚æœéœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œ**åªèƒ½è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„ Restful æ¥å£**ï¼Œä¸èƒ½æŸ¥è¯¢ç”¨æˆ·æ•°æ®åº“
å› æ­¤æˆ‘ä»¬éœ€è¦çŸ¥é“ Java å¦‚ä½•å»å‘é€ http è¯·æ±‚ï¼ŒSpring æä¾›äº†ä¸€ä¸ª RestTemplate å·¥å…·ï¼Œåªéœ€è¦æŠŠå®ƒåˆ›å»ºå‡ºæ¥å³å¯ã€‚ï¼ˆå³æ³¨å…¥ Beanï¼‰
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561706196-9816c07f-ecdd-42dc-aa12-810e9d2aae1d.png#averageHue=%23f1f4e7&clientId=ue42b8c5c-255d-4&from=paste&id=u6c546479&originHeight=179&originWidth=626&originalType=url&ratio=1&rotation=0&showTitle=false&size=29237&status=done&style=none&taskId=uf5e3f6f9-4d27-4c74-9eab-aec253f4d9e&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901090814.png)
å‘é€è¯·æ±‚ï¼Œè‡ªåŠ¨åºåˆ—åŒ–ä¸º Java å¯¹è±¡ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561713667-6a8aa51a-0c69-4459-b54f-e16dcaa73233.png#averageHue=%23f0f4e7&clientId=ue42b8c5c-255d-4&from=paste&id=ue93fffcc&originHeight=578&originWidth=1001&originalType=url&ratio=1&rotation=0&showTitle=false&size=128602&status=done&style=none&taskId=uefaf90ff-bd9f-4d11-905f-f5ffeb58935&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901090846.png)
å¯åŠ¨å®Œæˆåï¼Œè®¿é—®ï¼š[http://localhost:8080/order/101](http://localhost:8080/order/101)
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561718270-4f3a8521-842f-46ae-8819-16c7f0584293.png#averageHue=%23fefdfd&clientId=ue42b8c5c-255d-4&from=paste&id=u40f32196&originHeight=434&originWidth=636&originalType=url&ratio=1&rotation=0&showTitle=false&size=34047&status=done&style=none&taskId=ub829add2-defd-4a0c-85e7-39179509aef&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901090909.png)
åœ¨ä¸Šé¢ä»£ç çš„ url ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è°ƒç”¨æœåŠ¡çš„åœ°å€é‡‡ç”¨ç¡¬ç¼–ç ï¼Œè¿™åœ¨åç»­çš„å¼€å‘ä¸­è‚¯å®šæ˜¯ä¸ç†æƒ³çš„ï¼Œè¿™å°±éœ€è¦**æœåŠ¡æ³¨å†Œä¸­å¿ƒ**ï¼ˆEurekaï¼‰æ¥å¸®æˆ‘ä»¬è§£å†³è¿™ä¸ªäº‹æƒ…ã€‚
# Eurekaæ³¨å†Œä¸­å¿ƒ
æ¡ˆä¾‹æºç ï¼š[https://gitee.com/xn2001/cloudcode/tree/master/03-cloud-eureka](https://gitee.com/xn2001/cloudcode/tree/master/03-cloud-eureka)
æœ€å¹¿ä¸ºäººçŸ¥çš„æ³¨å†Œä¸­å¿ƒå°±æ˜¯ Eurekaï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561727116-b52842ed-5e1c-4ab5-8ca2-51bc2cd44e78.png#averageHue=%23e3ebd2&clientId=ue42b8c5c-255d-4&from=paste&id=u6112eb44&originHeight=838&originWidth=1454&originalType=url&ratio=1&rotation=0&showTitle=false&size=201015&status=done&style=none&taskId=u59b43d60-8059-4109-85ac-61a00f18bfe&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901090919.png)
**order-service å¦‚ä½•å¾—çŸ¥ user-service å®ä¾‹åœ°å€ï¼Ÿ**

- user-service æœåŠ¡å®ä¾‹å¯åŠ¨åï¼Œå°†è‡ªå·±çš„ä¿¡æ¯æ³¨å†Œåˆ° eureka-server(EurekaæœåŠ¡ç«¯)ï¼Œå«åš**æœåŠ¡æ³¨å†Œ**
- eureka-server ä¿å­˜æœåŠ¡åç§°åˆ°æœåŠ¡å®ä¾‹åœ°å€åˆ—è¡¨çš„æ˜ å°„å…³ç³»
- order-service æ ¹æ®æœåŠ¡åç§°ï¼Œæ‹‰å–å®ä¾‹åœ°å€åˆ—è¡¨ï¼Œè¿™ä¸ªå«**æœåŠ¡å‘ç°**æˆ–æœåŠ¡æ‹‰å–

**order-service å¦‚ä½•ä»å¤šä¸ª user-service å®ä¾‹ä¸­é€‰æ‹©å…·ä½“çš„å®ä¾‹ï¼Ÿ**
order-serviceä»å®ä¾‹åˆ—è¡¨ä¸­åˆ©ç”¨**è´Ÿè½½å‡è¡¡ç®—æ³•**é€‰ä¸­ä¸€ä¸ªå®ä¾‹åœ°å€ï¼Œå‘è¯¥å®ä¾‹åœ°å€å‘èµ·è¿œç¨‹è°ƒç”¨
**order-service å¦‚ä½•å¾—çŸ¥æŸä¸ª user-service å®ä¾‹æ˜¯å¦ä¾ç„¶å¥åº·ï¼Œæ˜¯ä¸æ˜¯å·²ç»å®•æœºï¼Ÿ**

- user-service ä¼š**æ¯éš”ä¸€æ®µæ—¶é—´(é»˜è®¤30ç§’)å‘ eureka-server å‘èµ·è¯·æ±‚**ï¼ŒæŠ¥å‘Šè‡ªå·±çŠ¶æ€ï¼Œç§°ä¸º**å¿ƒè·³**
- å½“è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å‘é€å¿ƒè·³æ—¶ï¼Œeureka-server ä¼šè®¤ä¸ºå¾®æœåŠ¡å®ä¾‹æ•…éšœï¼Œå°†è¯¥å®ä¾‹ä»æœåŠ¡åˆ—è¡¨ä¸­å‰”é™¤
- order-service æ‹‰å–æœåŠ¡æ—¶ï¼Œå°±èƒ½å°†æ•…éšœå®ä¾‹æ’é™¤äº†

---

æ¥ä¸‹æ¥æˆ‘ä»¬åŠ¨æ‰‹å®è·µçš„æ­¥éª¤åŒ…æ‹¬ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561728800-b51abf0b-058f-4d76-8816-7dbebbed1de3.png#averageHue=%23ddbaba&clientId=ue42b8c5c-255d-4&from=paste&id=ua8752638&originHeight=514&originWidth=1180&originalType=url&ratio=1&rotation=0&showTitle=false&size=91654&status=done&style=none&taskId=ufde2111c-9065-4fb7-8821-fc421733b59&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901090932.png)
## æ­å»ºæ³¨å†Œä¸­å¿ƒ
**æ­å»º eureka-server**
å¼•å…¥ SpringCloud ä¸º eureka æä¾›çš„ starter ä¾èµ–ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ç”¨ **server**
```xml
    <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>
```
**ç¼–å†™å¯åŠ¨ç±»**
æ³¨æ„è¦æ·»åŠ ä¸€ä¸ª @EnableEurekaServer **æ³¨è§£**ï¼Œå¼€å¯ eureka çš„**æ³¨å†Œä¸­å¿ƒ**åŠŸèƒ½
```java
@EnableEurekaServer
@SpringBootApplication
public class EurekaApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaApplication.class, args);
    }
}

```
**ç¼–å†™é…ç½®æ–‡ä»¶**
ç¼–å†™ä¸€ä¸ª application.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
```
server:
  port: 10086 #æœåŠ¡ç«¯å£
spring:
  application:
    name: eureka-server  #eurekaæœåŠ¡åç§°
eureka:
  client:
    service-url:   #eurekaåœ°å€ä¿¡æ¯
      defaultZone: http://127.0.0.1:10086/eureka
```
å…¶ä¸­ default-zone æ˜¯å› ä¸ºå‰é¢é…ç½®ç±»å¼€å¯äº†æ³¨å†Œä¸­å¿ƒæ‰€éœ€è¦é…ç½®çš„ eureka çš„**åœ°å€ä¿¡æ¯**ï¼Œå› ä¸º eureka æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œè¿™é‡Œä¹Ÿè¦å°†è‡ªå·±æ³¨å†Œè¿›æ¥ï¼Œå½“åé¢ eureka **é›†ç¾¤**æ—¶ï¼Œè¿™é‡Œå°±å¯ä»¥å¡«å†™å¤šä¸ªï¼Œä½¿ç”¨ â€œ,â€ éš”å¼€ã€‚
å¯åŠ¨å®Œæˆåï¼Œè®¿é—® [http://localhost:10086/](http://localhost:10086/)
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561728949-6e286f31-a86f-4a58-8e40-73afc75a5f9d.png#averageHue=%23cdcccb&clientId=ue42b8c5c-255d-4&from=paste&id=ubeb44f50&originHeight=731&originWidth=1009&originalType=url&ratio=1&rotation=0&showTitle=false&size=76883&status=done&style=none&taskId=u4f77e913-ee31-4e8d-a2c9-e187651c2a5&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901090945.png)
## æœåŠ¡æ³¨å†Œ
å°† user-serviceã€order-service éƒ½æ³¨å†Œåˆ° eureka
å¼•å…¥ SpringCloud ä¸º eureka æä¾›çš„ starter ä¾èµ–ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ç”¨ **client**
```xml
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-netflix-eureka-client</artifactId>
</dependency>

```
åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ï¼š@EnableEurekaClient
åœ¨ application.yml æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„é…ç½®ï¼š
```xml
spring:
  application:
    name: eureka-order

eureka:
  client:
    service-url:   #eurekaåœ°å€ä¿¡æ¯
      defaultZone: http://127.0.0.1:10086/eureka
```
3ä¸ªé¡¹ç›®å¯åŠ¨åï¼Œè®¿é—® [http://localhost:10086/](http://localhost:10086/)
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561729042-376cba98-04aa-4b4b-a916-ab4cadddc0cf.png#averageHue=%23d0cfce&clientId=ue42b8c5c-255d-4&from=paste&id=u61133168&originHeight=649&originWidth=1019&originalType=url&ratio=1&rotation=0&showTitle=false&size=84517&status=done&style=none&taskId=ub8465379-7542-4231-a2ef-c620a8f414e&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901090958.png)
è¿™é‡Œå¦å¤–å†è¡¥å……ä¸ªå°æŠ€å·§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ idea çš„å¤šå®ä¾‹å¯åŠ¨ï¼Œæ¥æŸ¥çœ‹ Eureka çš„é›†ç¾¤æ•ˆæœã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561730813-5ca04998-bd2a-4c6c-8aac-03115da725a3.png#averageHue=%23e4ebe1&clientId=ue42b8c5c-255d-4&from=paste&id=u39d078dd&originHeight=472&originWidth=1625&originalType=url&ratio=1&rotation=0&showTitle=false&size=215727&status=done&style=none&taskId=ub0758db9-5398-4a66-9c87-4b69bbee6d8&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091005.png)
4ä¸ªé¡¹ç›®å¯åŠ¨åï¼Œè®¿é—® [http://localhost:10086/](http://localhost:10086/)
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561730816-6125b0f1-ab82-4a10-997f-e4c9365faf6e.png#averageHue=%23dcd9d8&clientId=ue42b8c5c-255d-4&from=paste&id=udc4f9181&originHeight=327&originWidth=996&originalType=url&ratio=1&rotation=0&showTitle=false&size=46306&status=done&style=none&taskId=u81bc06a1-fb27-4860-be57-4be000225e8&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091015.png)
## æœåŠ¡æ‹‰å–
åœ¨ order-service ä¸­å®ŒæˆæœåŠ¡æ‹‰å–ï¼Œç„¶åé€šè¿‡è´Ÿè½½å‡è¡¡æŒ‘é€‰ä¸€ä¸ªæœåŠ¡ï¼Œå®ç°è¿œç¨‹è°ƒç”¨
ä¸‹é¢æˆ‘ä»¬è®© order-service å‘ eureka-server æ‹‰å– user-service çš„ä¿¡æ¯ï¼Œå®ç°æœåŠ¡å‘ç°ã€‚
é¦–å…ˆç»™ RestTemplate è¿™ä¸ª Bean æ·»åŠ ä¸€ä¸ª @LoadBalanced **æ³¨è§£**ï¼Œç”¨äºå¼€å¯**è´Ÿè½½å‡è¡¡**ã€‚ï¼ˆåé¢ä¼šè®²ï¼‰
**@Bean** **@LoadBalanced** **public** RestTemplate **restTemplate**(){     **return** **new** RestTemplate(); }
ä¿®æ”¹ OrderService è®¿é—®çš„urlè·¯å¾„ï¼Œç”¨**æœåŠ¡å**ä»£æ›¿ipã€ç«¯å£ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561733499-98627163-f722-4afe-b7d5-094c50801a47.png#averageHue=%23f5f9f2&clientId=ue42b8c5c-255d-4&from=paste&id=u04805848&originHeight=651&originWidth=1046&originalType=url&ratio=1&rotation=0&showTitle=false&size=204779&status=done&style=none&taskId=ue99ea9d0-4de2-4226-abf3-d0202faa1ad&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091216.png)
spring ä¼šè‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬ä» eureka-server ä¸­ï¼Œæ ¹æ® userservice è¿™ä¸ªæœåŠ¡åç§°ï¼Œè·å–å®ä¾‹åˆ—è¡¨åå»å®Œæˆè´Ÿè½½å‡è¡¡ã€‚
# Ribbonè´Ÿè½½å‡è¡¡
æ¡ˆä¾‹æºç ï¼š[https://gitee.com/xn2001/cloudcode/tree/master/04-cloud-ribbon](https://gitee.com/xn2001/cloudcode/tree/master/04-cloud-ribbon)
æˆ‘ä»¬æ·»åŠ äº† @LoadBalanced æ³¨è§£ï¼Œå³å¯å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œè¿™æ˜¯ä»€ä¹ˆåŸç†å‘¢ï¼Ÿ
**SpringCloud åº•å±‚æä¾›äº†ä¸€ä¸ªåä¸º Ribbon çš„ç»„ä»¶ï¼Œæ¥å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚**
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561735915-53623d73-4b8a-4d45-bdb0-6647c84b8e48.png#averageHue=%23fcf8f8&clientId=ue42b8c5c-255d-4&from=paste&id=u65cc347a&originHeight=647&originWidth=1573&originalType=url&ratio=1&rotation=0&showTitle=false&size=203697&status=done&style=none&taskId=u4f50ab56-275f-4590-bb1e-4e8865387a1&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091242.png)
## æºç è·Ÿè¸ª
ä¸ºä»€ä¹ˆæˆ‘ä»¬åªè¾“å…¥äº† service åç§°å°±å¯ä»¥è®¿é—®äº†å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸éœ€è¦è·å–ipå’Œç«¯å£ï¼Œè¿™æ˜¾ç„¶æœ‰äººå¸®æˆ‘ä»¬æ ¹æ® service åç§°ï¼Œè·å–åˆ°äº†æœåŠ¡å®ä¾‹çš„ipå’Œç«¯å£ã€‚å®ƒå°±æ˜¯LoadBalancerInterceptorï¼Œè¿™ä¸ªç±»ä¼šåœ¨å¯¹ RestTemplate çš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œç„¶åä» Eureka æ ¹æ®æœåŠ¡ id è·å–æœåŠ¡åˆ—è¡¨ï¼Œéšååˆ©ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•å¾—åˆ°çœŸå®çš„æœåŠ¡åœ°å€ä¿¡æ¯ï¼Œæ›¿æ¢æœåŠ¡ idã€‚
æˆ‘ä»¬è¿›è¡Œæºç è·Ÿè¸ªï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561733305-22427235-3ebb-4ebf-ba4f-69b37a50d456.png#averageHue=%233f3d3c&clientId=ue42b8c5c-255d-4&from=paste&id=ue69d06f5&originHeight=435&originWidth=864&originalType=url&ratio=1&rotation=0&showTitle=false&size=58317&status=done&style=none&taskId=u6f43d61c-4c56-4f09-8491-142ba510f9b&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091323.png)
è¿™é‡Œçš„ intercept() æ–¹æ³•ï¼Œæ‹¦æˆªäº†ç”¨æˆ·çš„ HttpRequest è¯·æ±‚ï¼Œç„¶ååšäº†å‡ ä»¶äº‹ï¼š

- request.getURI()ï¼šè·å–è¯·æ±‚uriï¼Œå³ [http://user-service/user/8](http://user-service/user/8)
- originalUri.getHost()ï¼šè·å–uriè·¯å¾„çš„ä¸»æœºåï¼Œå…¶å®å°±æ˜¯æœåŠ¡id user-service
- this.loadBalancer.execute()ï¼šå¤„ç†æœåŠ¡idï¼Œå’Œç”¨æˆ·è¯·æ±‚

è¿™é‡Œçš„ this.loadBalancer æ˜¯ LoadBalancerClient ç±»å‹
ç»§ç»­è·Ÿå…¥ execute() æ–¹æ³•ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561736018-28e533d2-9297-4ccd-a091-81b7e2106cdc.png#averageHue=%23444342&clientId=ue42b8c5c-255d-4&from=paste&id=u9d23624b&originHeight=266&originWidth=937&originalType=url&ratio=1&rotation=0&showTitle=false&size=34936&status=done&style=none&taskId=u48c45f49-9856-4a2d-9424-3426762bec0&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091330.png)

- getLoadBalancer(serviceId)ï¼šæ ¹æ®æœåŠ¡idè·å– ILoadBalancerï¼Œè€Œ ILoadBalancer ä¼šæ‹¿ç€æœåŠ¡ id å» eureka ä¸­è·å–æœåŠ¡åˆ—è¡¨ã€‚
- getServer(loadBalancer)ï¼šåˆ©ç”¨å†…ç½®çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œä»æœåŠ¡åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªã€‚åœ¨å›¾ä¸­**å¯ä»¥çœ‹åˆ°è·å–äº†8082ç«¯å£çš„æœåŠ¡**

å¯ä»¥çœ‹åˆ°è·å–æœåŠ¡æ—¶ï¼Œé€šè¿‡ä¸€ä¸ª getServer() æ–¹æ³•æ¥åšè´Ÿè½½å‡è¡¡:
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561737928-87342d32-a48f-45d8-8270-85c7229003ea.png#averageHue=%23595452&clientId=ue42b8c5c-255d-4&from=paste&id=u6f0437ab&originHeight=145&originWidth=724&originalType=url&ratio=1&rotation=0&showTitle=false&size=18592&status=done&style=none&taskId=u7d8ffe09-d479-4858-8b54-86f5b028bd2&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091345.png)
æˆ‘ä»¬ç»§ç»­è·Ÿå…¥ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561738526-4eaaec6f-5544-45ff-ad60-2feca681264b.png#averageHue=%23f4f3f0&clientId=ue42b8c5c-255d-4&from=paste&id=ue3882444&originHeight=228&originWidth=927&originalType=url&ratio=1&rotation=0&showTitle=false&size=24579&status=done&style=none&taskId=ub1dba155-e2d0-4c49-8ed4-785a29a0cef&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091355.png)
ç»§ç»­è·Ÿè¸ªæºç  chooseServer() æ–¹æ³•ï¼Œå‘ç°è¿™ä¹ˆä¸€æ®µä»£ç ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561738510-a5b95c8f-c67b-441d-acde-90698c4844a4.png#averageHue=%2341403f&clientId=ue42b8c5c-255d-4&from=paste&id=ue0ec629d&originHeight=408&originWidth=600&originalType=url&ratio=1&rotation=0&showTitle=false&size=32303&status=done&style=none&taskId=u42ade7fe-3819-45cc-ab51-ee3c8b04469&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091414.png)
æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª rule æ˜¯è°ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561740681-7dfe75fc-ca2b-4254-9d49-4d3d581f4666.png#averageHue=%23454341&clientId=ue42b8c5c-255d-4&from=paste&id=u56c4d16e&originHeight=270&originWidth=724&originalType=url&ratio=1&rotation=0&showTitle=false&size=31575&status=done&style=none&taskId=u79fa1ffd-63ef-4633-8a42-9fb4dc1e9e4&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091432.png)
è¿™é‡Œçš„ rule é»˜è®¤å€¼æ˜¯ä¸€ä¸ª RoundRobinRule ï¼Œçœ‹ç±»çš„ä»‹ç»ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561740695-e0d9b7f8-4f6a-4d12-9847-681b37c06afd.png#averageHue=%234a4a49&clientId=ue42b8c5c-255d-4&from=paste&id=u45489dec&originHeight=176&originWidth=705&originalType=url&ratio=1&rotation=0&showTitle=false&size=13807&status=done&style=none&taskId=uc289be93-fd57-4e7f-8c02-e8477e39677&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091442.png)
è´Ÿè½½å‡è¡¡é»˜è®¤ä½¿ç”¨äº†è½®è®­ç®—æ³•ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ã€‚
## æµç¨‹æ€»ç»“
SpringCloud Ribbon åº•å±‚é‡‡ç”¨äº†ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæ‹¦æˆªäº† RestTemplate å‘å‡ºçš„è¯·æ±‚ï¼Œå¯¹åœ°å€åšäº†ä¿®æ”¹ã€‚
åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

- æ‹¦æˆªæˆ‘ä»¬çš„ RestTemplate è¯·æ±‚ [http://userservice/user/1](http://userservice/user/1)
- RibbonLoadBalancerClient ä¼šä»è¯·æ±‚urlä¸­è·å–æœåŠ¡åç§°ï¼Œä¹Ÿå°±æ˜¯ user-service
- DynamicServerListLoadBalancer æ ¹æ® user-service åˆ° eureka æ‹‰å–æœåŠ¡åˆ—è¡¨
- eureka è¿”å›åˆ—è¡¨ï¼Œlocalhost:8081ã€localhost:8082
- IRule åˆ©ç”¨å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œä¾‹å¦‚ localhost:8081
- RibbonLoadBalancerClient ä¿®æ”¹è¯·æ±‚åœ°å€ï¼Œç”¨ localhost:8081 æ›¿ä»£ userserviceï¼Œå¾—åˆ° [http://localhost:8081/user/1](http://localhost:8081/user/1)ï¼Œå‘èµ·çœŸå®è¯·æ±‚

[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561745688-b5fa11f8-000e-4d6d-8472-223ffa534e90.png#averageHue=%23f9f6f6&clientId=ue42b8c5c-255d-4&from=paste&id=uf5d2f8c6&originHeight=722&originWidth=1601&originalType=url&ratio=1&rotation=0&showTitle=false&size=150439&status=done&style=none&taskId=u1529f337-d489-49bf-88a5-a8a8f645f71&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091755.png)
## è´Ÿè½½å‡è¡¡ç­–ç•¥
è´Ÿè½½å‡è¡¡çš„è§„åˆ™éƒ½å®šä¹‰åœ¨ IRule æ¥å£ä¸­ï¼Œè€Œ IRule æœ‰å¾ˆå¤šä¸åŒçš„å®ç°ç±»ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561746326-7582518b-e3d4-494e-9450-55865c5e0315.png#averageHue=%23edf5e5&clientId=ue42b8c5c-255d-4&from=paste&id=u1e738d8a&originHeight=512&originWidth=1386&originalType=url&ratio=1&rotation=0&showTitle=false&size=268215&status=done&style=none&taskId=u6b439a2a-95ea-4685-9fff-6d1cd5c6a7d&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091811.png)
ä¸åŒè§„åˆ™çš„å«ä¹‰å¦‚ä¸‹ï¼š

| **å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ç±»** | **è§„åˆ™æè¿°** |
| --- | --- |
| RoundRobinRule | ç®€å•è½®è¯¢æœåŠ¡åˆ—è¡¨æ¥é€‰æ‹©æœåŠ¡å™¨ã€‚å®ƒæ˜¯Ribboné»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ã€‚ |
| AvailabilityFilteringRule | å¯¹ä»¥ä¸‹ä¸¤ç§æœåŠ¡å™¨è¿›è¡Œå¿½ç•¥ï¼šï¼ˆ1ï¼‰åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™å°æœåŠ¡å™¨å¦‚æœ3æ¬¡è¿æ¥å¤±è´¥ï¼Œè¿™å°æœåŠ¡å™¨å°±ä¼šè¢«è®¾ç½®ä¸ºâ€œçŸ­è·¯â€çŠ¶æ€ã€‚çŸ­è·¯çŠ¶æ€å°†æŒç»­30ç§’ï¼Œå¦‚æœå†æ¬¡è¿æ¥å¤±è´¥ï¼ŒçŸ­è·¯çš„æŒç»­æ—¶é—´å°±ä¼šå‡ ä½•çº§åœ°å¢åŠ ã€‚ ï¼ˆ2ï¼‰å¹¶å‘æ•°è¿‡é«˜çš„æœåŠ¡å™¨ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡å™¨çš„å¹¶å‘è¿æ¥æ•°è¿‡é«˜ï¼Œé…ç½®äº†AvailabilityFilteringRule è§„åˆ™çš„å®¢æˆ·ç«¯ä¹Ÿä¼šå°†å…¶å¿½ç•¥ã€‚å¹¶å‘è¿æ¥æ•°çš„ä¸Šé™ï¼Œå¯ä»¥ç”±å®¢æˆ·ç«¯è®¾ç½®ã€‚ |
| WeightedResponseTimeRule | ä¸ºæ¯ä¸€ä¸ªæœåŠ¡å™¨èµ‹äºˆä¸€ä¸ªæƒé‡å€¼ã€‚æœåŠ¡å™¨å“åº”æ—¶é—´è¶Šé•¿ï¼Œè¿™ä¸ªæœåŠ¡å™¨çš„æƒé‡å°±è¶Šå°ã€‚è¿™ä¸ªè§„åˆ™ä¼šéšæœºé€‰æ‹©æœåŠ¡å™¨ï¼Œè¿™ä¸ªæƒé‡å€¼ä¼šå½±å“æœåŠ¡å™¨çš„é€‰æ‹©ã€‚ |
| **ZoneAvoidanceRule** | ä»¥åŒºåŸŸå¯ç”¨çš„æœåŠ¡å™¨ä¸ºåŸºç¡€è¿›è¡ŒæœåŠ¡å™¨çš„é€‰æ‹©ã€‚ä½¿ç”¨Zoneå¯¹æœåŠ¡å™¨è¿›è¡Œåˆ†ç±»ï¼Œè¿™ä¸ªZoneå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæœºæˆ¿ã€ä¸€ä¸ªæœºæ¶ç­‰ã€‚è€Œåå†å¯¹Zoneå†…çš„å¤šä¸ªæœåŠ¡åšè½®è¯¢ã€‚ |
| BestAvailableRule | å¿½ç•¥é‚£äº›çŸ­è·¯çš„æœåŠ¡å™¨ï¼Œå¹¶é€‰æ‹©å¹¶å‘æ•°è¾ƒä½çš„æœåŠ¡å™¨ã€‚ |
| RandomRule | éšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å™¨ã€‚ |
| RetryRule | é‡è¯•æœºåˆ¶çš„é€‰æ‹©é€»è¾‘ |

é»˜è®¤çš„å®ç°å°±æ˜¯ ZoneAvoidanceRuleï¼Œ**æ˜¯ä¸€ç§è½®è¯¢æ–¹æ¡ˆ**ã€‚
## è‡ªå®šä¹‰ç­–ç•¥
é€šè¿‡å®šä¹‰ IRule å®ç°å¯ä»¥ä¿®æ”¹è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š
1 ä»£ç æ–¹å¼åœ¨ order-service ä¸­çš„ OrderApplication ç±»ä¸­ï¼Œå®šä¹‰ä¸€ä¸ªæ–°çš„ IRuleï¼š
(å…¨å±€ç”Ÿæ•ˆï¼Œè°ƒç”¨æ‰€æœ‰å¾®æœåŠ¡éƒ½ç”Ÿæ•ˆ)
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561746529-418e0e92-1518-46ec-a9ff-4c3b20c2fab7.png#averageHue=%23f5f3d8&clientId=ue42b8c5c-255d-4&from=paste&id=u967adab0&originHeight=558&originWidth=1210&originalType=url&ratio=1&rotation=0&showTitle=false&size=346157&status=done&style=none&taskId=uf6b9b57f-94c6-4a07-80d3-6ae947f8e79&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091832.png)
2 é…ç½®æ–‡ä»¶æ–¹å¼ï¼šåœ¨ order-service çš„ application.yml æ–‡ä»¶ä¸­ï¼Œæ·»åŠ æ–°çš„é…ç½®ä¹Ÿå¯ä»¥ä¿®æ”¹è§„åˆ™ï¼šï¼ˆå½“å‰å¾®æœåŠ¡ï¼‰
```xml
eureka-service:# ç»™éœ€è¦è°ƒç”¨çš„å¾®æœåŠ¡é…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼ŒorderserviceæœåŠ¡å»è°ƒç”¨userserviceæœåŠ¡  
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule # è´Ÿè½½å‡è¡¡è§„åˆ™
```
**æ³¨æ„**ï¼šä¸€èˆ¬ç”¨é»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä¸åšä¿®æ”¹ã€‚
## é¥¥é¥¿åŠ è½½
å½“æˆ‘ä»¬å¯åŠ¨ orderserviceï¼Œç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼Œæ—¶é—´æ¶ˆè€—ä¼šå¤§å¾ˆå¤šï¼Œè¿™æ˜¯å› ä¸º Ribbon æ‡’åŠ è½½çš„æœºåˆ¶ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561747443-49d7322d-c0b5-40e4-9a17-64350b242d2c.png#averageHue=%23f5f1ef&clientId=ue42b8c5c-255d-4&from=paste&id=ue2ae06b3&originHeight=269&originWidth=793&originalType=url&ratio=1&rotation=0&showTitle=false&size=31075&status=done&style=none&taskId=u2456cd8c-ad62-4137-80d0-935fdd0e2b5&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091850.png)
Ribbon é»˜è®¤æ˜¯é‡‡ç”¨æ‡’åŠ è½½ï¼Œå³ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ‰ä¼šå»åˆ›å»º LoadBalanceClientï¼Œæ‹‰å–é›†ç¾¤åœ°å€ï¼Œæ‰€ä»¥è¯·æ±‚æ—¶é—´ä¼šå¾ˆé•¿ã€‚
è€Œé¥¥é¥¿åŠ è½½åˆ™ä¼šåœ¨é¡¹ç›®å¯åŠ¨æ—¶åˆ›å»º LoadBalanceClientï¼Œé™ä½ç¬¬ä¸€æ¬¡è®¿é—®çš„è€—æ—¶ï¼Œé€šè¿‡ä¸‹é¢é…ç½®å¼€å¯é¥¥é¥¿åŠ è½½ï¼š
ribbon:   eager-load:     enabled: true     clients: userservice _# é¡¹ç›®å¯åŠ¨æ—¶ç›´æ¥å»æ‹‰å–userserviceçš„é›†ç¾¤ï¼Œå¤šä¸ªç”¨","éš”å¼€_
```xml
ribbon:
  eager-load:
    enabled: true
    clients:
      -eureka-service
```
# Nacosæ³¨å†Œä¸­å¿ƒ
æºç æ¡ˆä¾‹ï¼š[https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos](https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos)
SpringCloudAlibaba æ¨å‡ºäº†ä¸€ä¸ªåä¸º Nacos çš„æ³¨å†Œä¸­å¿ƒï¼Œåœ¨å›½å¤–ä¹Ÿæœ‰å¤§é‡çš„ä½¿ç”¨ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561749206-b0ab84b2-3da9-4b3c-9b41-260cedfd7fc2.png#averageHue=%23fcfbfb&clientId=ue42b8c5c-255d-4&from=paste&id=u30f26172&originHeight=714&originWidth=1379&originalType=url&ratio=1&rotation=0&showTitle=false&size=129130&status=done&style=none&taskId=u4cbd4c47-115a-4729-a3d3-b74e48e2a91&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091857.png)
è§£å‹å¯åŠ¨ Nacosï¼Œè¯¦ç»†è¯·çœ‹ [Nacoså®‰è£…æŒ‡å—](https://www.xn2001.com/archives/661.html)
startup.cmd -m standalone
è®¿é—®ï¼š[http://localhost:8848/nacos/](http://localhost:8848/nacos/)
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561748661-2dcdf01b-3025-433a-ae46-ffc5332af92b.png#averageHue=%23e9d8ae&clientId=ue42b8c5c-255d-4&from=paste&id=ua8719e4a&originHeight=530&originWidth=1029&originalType=url&ratio=1&rotation=0&showTitle=false&size=36093&status=done&style=none&taskId=u2b9c85c0-3cf8-4760-8f90-ff4ca6ba554&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091904.png)
## æœåŠ¡æ³¨å†Œ
è¿™é‡Œä¸Šæ¥å°±ç›´æ¥æœåŠ¡æ³¨å†Œï¼Œå¾ˆå¤šä¸œè¥¿å¯èƒ½æœ‰ç–‘æƒ‘ï¼Œå…¶å® Nacos æœ¬èº«å°±æ˜¯ä¸€ä¸ª SprintBoot é¡¹ç›®ï¼Œè¿™ç‚¹ä½ ä»å¯åŠ¨çš„æ§åˆ¶å°æ‰“å°å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ‰€ä»¥å°±ä¸å†éœ€è¦å»é¢å¤–æ­å»ºä¸€ä¸ªåƒ Eureka çš„æ³¨å†Œä¸­å¿ƒã€‚
**å¼•å…¥ä¾èµ–**
åœ¨ cloud-demo çˆ¶å·¥ç¨‹ä¸­å¼•å…¥ SpringCloudAlibaba çš„ä¾èµ–ï¼š
```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-dependencies</artifactId>
      <version>2.2.6.RELEASE</version>
    <type>pom</type>
    <scope>import</scope>
</dependency>
```
ç„¶ååœ¨ user-service å’Œ order-service ä¸­çš„pomæ–‡ä»¶ä¸­å¼•å…¥ nacos-discovery ä¾èµ–ï¼š
```xml
<dependency>     
    <groupId>com.alibaba.cloud</groupId>     
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId> 
</dependency>
```
**é…ç½®nacosåœ°å€**
åœ¨ user-service å’Œ order-service çš„ application.yml ä¸­æ·»åŠ  nacos åœ°å€ï¼š
```xml
springï¼š
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848
```
é¡¹ç›®é‡æ–°å¯åŠ¨åï¼Œå¯ä»¥çœ‹åˆ°ä¸‰ä¸ªæœåŠ¡éƒ½è¢«æ³¨å†Œè¿›äº† Nacos
è€ç‰ˆæœ¬ï¼šæ·»åŠ å¯åŠ¨ç±»æ³¨è§£
@EnableDiscoveryClient
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561748681-d9468768-ed8f-4ee1-8b7d-ff4f2e3fb2fd.png#averageHue=%23fafaf9&clientId=ue42b8c5c-255d-4&from=paste&id=u744b23ca&originHeight=343&originWidth=829&originalType=url&ratio=1&rotation=0&showTitle=false&size=26538&status=done&style=none&taskId=u50e49fcb-64f7-4159-b3a3-2093346b8f4&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091918.png)
æµè§ˆå™¨è®¿é—®ï¼š[http://localhost:8080/order/101](http://localhost:8080/order/101)ï¼Œæ­£å¸¸è®¿é—®ï¼ŒåŒæ—¶è´Ÿè½½å‡è¡¡ä¹Ÿæ­£å¸¸ã€‚
## åˆ†çº§å­˜å‚¨æ¨¡å‹
ä¸€ä¸ª**æœåŠ¡**å¯ä»¥æœ‰å¤šä¸ª**å®ä¾‹**ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„ user-serviceï¼Œå¯ä»¥æœ‰:

- 127.0.0.1:8081
- 127.0.0.1:8082
- 127.0.0.1:8083

å‡å¦‚è¿™äº›å®ä¾‹åˆ†å¸ƒäºå…¨å›½å„åœ°çš„ä¸åŒæœºæˆ¿ï¼Œä¾‹å¦‚ï¼š

- 127.0.0.1:8081ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿
- 127.0.0.1:8082ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿
- 127.0.0.1:8083ï¼Œåœ¨æ­å·æœºæˆ¿

Nacoså°±å°†åŒä¸€æœºæˆ¿å†…çš„å®ä¾‹ï¼Œåˆ’åˆ†ä¸ºä¸€ä¸ª**é›†ç¾¤**ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561752579-c5feab6a-5202-4cb5-947b-83bf6a564788.png#averageHue=%23faf9f6&clientId=ue42b8c5c-255d-4&from=paste&id=u4a39b26d&originHeight=770&originWidth=1554&originalType=url&ratio=1&rotation=0&showTitle=false&size=184126&status=done&style=none&taskId=ub3526f13-5531-40ad-91b0-298ae84a875&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091928.png)
å¾®æœåŠ¡äº’ç›¸è®¿é—®æ—¶ï¼Œåº”è¯¥å°½å¯èƒ½è®¿é—®åŒé›†ç¾¤å®ä¾‹ï¼Œå› ä¸ºæœ¬åœ°è®¿é—®é€Ÿåº¦æ›´å¿«ã€‚**å½“æœ¬é›†ç¾¤å†…ä¸å¯ç”¨æ—¶ï¼Œæ‰è®¿é—®å…¶å®ƒé›†ç¾¤ã€‚**ä¾‹å¦‚ï¼šæ­å·æœºæˆ¿å†…çš„ order-service åº”è¯¥ä¼˜å…ˆè®¿é—®åŒæœºæˆ¿çš„ user-serviceã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561750922-4ce1d7ae-2a33-4c73-826d-389a084725ca.png#averageHue=%239ebb64&clientId=ue42b8c5c-255d-4&from=paste&id=u4e1fc20e&originHeight=450&originWidth=1316&originalType=url&ratio=1&rotation=0&showTitle=false&size=55102&status=done&style=none&taskId=uea0a6c31-aefc-4664-9875-2c45b673050&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091937.png)
## é…ç½®é›†ç¾¤
ğŸ™„ğŸ™„ğŸ™„ğŸ™„
è°ƒç”¨æ–¹ï¼š(æœ€æ–°ç‰ˆæœ¬éœ€è¦)
```xml
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-loadbalancer</artifactId>
            <version>3.1.0</version>
        </dependency>
```
æ¥ä¸‹æ¥æˆ‘ä»¬ç»™ user-service **é…ç½®é›†ç¾¤**
ä¿®æ”¹ user-service çš„ application.yml æ–‡ä»¶ï¼Œæ·»åŠ é›†ç¾¤é…ç½®ï¼š
```xml
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848
      discovery:
        cluster-name: SH #é›†ç¾¤
```
é‡å¯ä¸¤ä¸ª user-service å®ä¾‹åï¼Œæˆ‘ä»¬å†å»å¯åŠ¨ä¸€ä¸ªä¸Šæµ·é›†ç¾¤çš„å®ä¾‹ã€‚
-Dserver.port=8083 -Dspring.cloud.nacos.discovery.cluster-name=SH
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561752993-84fd0bfc-469b-41e6-aba2-986d5da1494c.png#averageHue=%23f1f0f0&clientId=ue42b8c5c-255d-4&from=paste&id=u952a1d1f&originHeight=295&originWidth=722&originalType=url&ratio=1&rotation=0&showTitle=false&size=20326&status=done&style=none&taskId=u6554cc3a-c3f1-4b97-b861-1277ec2cb2d&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091947.png)
æŸ¥çœ‹ nacos æ§åˆ¶å°ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561753416-de15855e-75fe-4f46-a98a-2ebc7ffcfac1.png#averageHue=%23e3fbd7&clientId=ue42b8c5c-255d-4&from=paste&id=ub27265af&originHeight=587&originWidth=1036&originalType=url&ratio=1&rotation=0&showTitle=false&size=46020&status=done&style=none&taskId=ue7354df2-db1c-4208-931b-aeed0d09404&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901091957.png)
## NacosRule
Ribbonçš„é»˜è®¤å®ç° ZoneAvoidanceRule å¹¶ä¸èƒ½å®ç°æ ¹æ®åŒé›†ç¾¤ä¼˜å…ˆæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬æŠŠè§„åˆ™æ”¹æˆ **NacosRule** å³å¯ã€‚æˆ‘ä»¬æ˜¯ç”¨ orderservice è°ƒç”¨ userserviceï¼Œæ‰€ä»¥åœ¨ orderservice é…ç½®è§„åˆ™ã€‚
```java
@Bean
public IRule iRule() {
     //é»˜è®¤ä¸ºè½®è¯¢è§„åˆ™ï¼Œè¿™é‡Œè‡ªå®šä¹‰ä¸ºéšæœºè§„åˆ™ 
    return new NacosRule();
    }
```
å¦å¤–ï¼Œä½ åŒæ ·å¯ä»¥ä½¿ç”¨é…ç½®çš„å½¢å¼æ¥å®Œæˆï¼Œå…·ä½“å‚è€ƒä¸Šé¢çš„ Ribbon æ ç›®ã€‚
```
user-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.alibaba.cloud.nacos.ribbon.NacosRule  # è´Ÿè½½å‡è¡¡è§„åˆ™
```
ç„¶åï¼Œå†å¯¹ orderservice é…ç½®é›†ç¾¤ã€‚
```
spring:
  cloud:
    nacos:
      discovery:
        cluster-name: BJ
```
ç°åœ¨æˆ‘å¯åŠ¨äº†å››ä¸ªæœåŠ¡ï¼Œåˆ†åˆ«æ˜¯ï¼š

- orderservice - HZ
- userservice - HZ
- userservice1 - HZ
- userservice2 - SH

è®¿é—®åœ°å€ï¼š[http://localhost:8080/order/101](http://localhost:8080/order/101)
åœ¨è®¿é—®ä¸­æˆ‘ä»¬å‘ç°ï¼Œåªæœ‰åŒåœ¨ä¸€ä¸ª HZ é›†ç¾¤ä¸‹çš„ userserviceã€userservice1 ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¸”æ˜¯éšæœºçš„ã€‚
æˆ‘ä»¬è¯•ç€æŠŠ userserviceã€userservice2 åœæ‰ã€‚ä¾æ—§å¯ä»¥è®¿é—®ã€‚
åœ¨ userservice3 æ§åˆ¶å°å¯ä»¥çœ‹åˆ°å‘å‡ºäº†ä¸€ä¸²çš„è­¦å‘Šï¼Œå› ä¸º orderservice æœ¬èº«æ˜¯åœ¨ HZ é›†ç¾¤çš„ï¼Œè¿™æ³¢ HZ é›†ç¾¤æ²¡æœ‰äº† userserviceï¼Œå°±ä¼šå»åˆ«çš„é›†ç¾¤æ‰¾ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561754793-3cb7059f-4435-415e-9fc4-dd4467358508.png#averageHue=%23e6efc9&clientId=ue42b8c5c-255d-4&from=paste&id=u74f7344f&originHeight=340&originWidth=1215&originalType=url&ratio=1&rotation=0&showTitle=false&size=298859&status=done&style=none&taskId=uc4753a9a-fceb-472c-92d4-9fdae828821&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092012.png)
## æƒé‡é…ç½®
å®é™…éƒ¨ç½²ä¸­ä¼šå‡ºç°è¿™æ ·çš„åœºæ™¯ï¼š
æœåŠ¡å™¨è®¾å¤‡æ€§èƒ½æœ‰å·®å¼‚ï¼Œéƒ¨åˆ†å®ä¾‹æ‰€åœ¨æœºå™¨æ€§èƒ½è¾ƒå¥½ï¼Œå¦ä¸€äº›è¾ƒå·®ï¼Œæˆ‘ä»¬å¸Œæœ›æ€§èƒ½å¥½çš„æœºå™¨æ‰¿æ‹…æ›´å¤šçš„ç”¨æˆ·è¯·æ±‚ã€‚ä½†é»˜è®¤æƒ…å†µä¸‹ NacosRule æ˜¯åŒé›†ç¾¤å†…éšæœºæŒ‘é€‰ï¼Œä¸ä¼šè€ƒè™‘æœºå™¨çš„æ€§èƒ½é—®é¢˜ã€‚
å› æ­¤ï¼ŒNacos æä¾›äº†**æƒé‡é…ç½®æ¥æ§åˆ¶è®¿é—®é¢‘ç‡**ï¼Œ0~1 ä¹‹é—´ï¼Œæƒé‡è¶Šå¤§åˆ™è®¿é—®é¢‘ç‡è¶Šé«˜ï¼Œæƒé‡ä¿®æ”¹ä¸º 0ï¼Œåˆ™è¯¥å®ä¾‹æ°¸è¿œä¸ä¼šè¢«è®¿é—®ã€‚
åœ¨ Nacos æ§åˆ¶å°ï¼Œæ‰¾åˆ° user-service çš„å®ä¾‹åˆ—è¡¨ï¼Œç‚¹å‡»ç¼–è¾‘ï¼Œå³å¯ä¿®æ”¹æƒé‡ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561755319-ffaf470a-866d-46da-8d1b-44b067c08ce8.png#averageHue=%23e3fbd8&clientId=ue42b8c5c-255d-4&from=paste&id=ucbe16aae&originHeight=357&originWidth=1229&originalType=url&ratio=1&rotation=0&showTitle=false&size=31730&status=done&style=none&taskId=uab876290-ba7a-4209-b562-dfa37704439&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092020.png)
åœ¨å¼¹å‡ºçš„ç¼–è¾‘çª—å£ï¼Œä¿®æ”¹æƒé‡
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561756325-7964ae6d-3b73-479f-a5de-eddb3121e6f2.png#averageHue=%23c0c0c0&clientId=ue42b8c5c-255d-4&from=paste&id=u917a978f&originHeight=639&originWidth=749&originalType=url&ratio=1&rotation=0&showTitle=false&size=26163&status=done&style=none&taskId=u8b9a60bc-c782-4d63-89ac-6484c1f8664&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092026.png)
å¦å¤–ï¼Œåœ¨æœåŠ¡å‡çº§çš„æ—¶å€™ï¼Œæœ‰ä¸€ç§è¾ƒå¥½çš„æ–¹æ¡ˆï¼šæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è°ƒæ•´æƒé‡æ¥è¿›è¡Œå¹³æ»‘å‡çº§ï¼Œä¾‹å¦‚ï¼šå…ˆæŠŠ userservice æƒé‡è°ƒèŠ‚ä¸º 0ï¼Œè®©ç”¨æˆ·å…ˆæµå‘ userservice2ã€userservice3ï¼Œå‡çº§ userserviceåï¼Œå†æŠŠæƒé‡ä» 0 è°ƒåˆ° 0.1ï¼Œè®©ä¸€éƒ¨åˆ†ç”¨æˆ·å…ˆä½“éªŒï¼Œç”¨æˆ·ä½“éªŒç¨³å®šåå°±å¯ä»¥å¾€ä¸Šè°ƒæƒé‡å•¦ã€‚

ğŸ§æƒé‡ä¸èƒ½ä¿®æ”¹æŠ¥é”™500é—®é¢˜ï¼š
åˆ é™¤nacos--->dataä¸‹é¢çš„protocal

## ç¯å¢ƒéš”ç¦»
Nacos æä¾›äº† namespace æ¥å®ç°ç¯å¢ƒéš”ç¦»åŠŸèƒ½ã€‚

- Nacos ä¸­å¯ä»¥æœ‰å¤šä¸ª namespace
- namespace ä¸‹å¯ä»¥æœ‰ groupã€service ç­‰
- ä¸åŒ namespace ä¹‹é—´**ç›¸äº’éš”ç¦»**ï¼Œä¾‹å¦‚ä¸åŒ namespace çš„æœåŠ¡äº’ç›¸ä¸å¯è§

[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561757563-d7442d8d-0e74-4378-bc3e-3633b7746e51.png#averageHue=%2377afbe&clientId=ue42b8c5c-255d-4&from=paste&id=u89ba372c&originHeight=650&originWidth=1067&originalType=url&ratio=1&rotation=0&showTitle=false&size=244289&status=done&style=none&taskId=uec887c4f-57af-4950-88f2-19925b67c2f&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092032.png)
### åˆ›å»ºnamespace
é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ serviceã€dataã€group éƒ½åœ¨åŒä¸€ä¸ª namespaceï¼Œåä¸º public(ä¿ç•™ç©ºé—´)ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561756428-60bfb834-2947-472c-bc65-d86020a3d793.png#averageHue=%23e8ecce&clientId=ue42b8c5c-255d-4&from=paste&id=u95b4851b&originHeight=437&originWidth=556&originalType=url&ratio=1&rotation=0&showTitle=false&size=18324&status=done&style=none&taskId=u0c9a6a34-e34e-4408-bd03-c659a827c3f&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092038.png)
æˆ‘ä»¬å¯ä»¥ç‚¹å‡»é¡µé¢æ–°å¢æŒ‰é’®ï¼Œæ·»åŠ ä¸€ä¸ª namespaceï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561756807-29eaaf2a-b822-4e44-8e44-57e162f55d60.png#averageHue=%23c5b8a4&clientId=ue42b8c5c-255d-4&from=paste&id=u4d03d722&originHeight=439&originWidth=724&originalType=url&ratio=1&rotation=0&showTitle=false&size=66457&status=done&style=none&taskId=u7aa173c8-3f3f-4195-bb5c-2f2fd7ced68&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092050.png)
ç„¶åï¼Œå¡«å†™è¡¨å•ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561759094-b81767da-150a-4a20-a31f-227d35c38caf.png#averageHue=%23f7f0f0&clientId=ue42b8c5c-255d-4&from=paste&id=u644b8990&originHeight=433&originWidth=723&originalType=url&ratio=1&rotation=0&showTitle=false&size=22302&status=done&style=none&taskId=ub9fabdb4-de44-4aaf-a335-baa13a36a6c&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092059.png)
å°±èƒ½åœ¨é¡µé¢çœ‹åˆ°ä¸€ä¸ªæ–°çš„ namespaceï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561759145-823badd6-b19d-40d6-b361-ba44dacdd829.png#averageHue=%23e5c38f&clientId=ue42b8c5c-255d-4&from=paste&id=ue8707c34&originHeight=289&originWidth=848&originalType=url&ratio=1&rotation=0&showTitle=false&size=21040&status=done&style=none&taskId=u1ad3afa5-d9c8-4368-8ebd-82af4cd4756&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092114.png)
### é…ç½®namespace
ç»™å¾®æœåŠ¡é…ç½® namespace åªèƒ½é€šè¿‡ä¿®æ”¹é…ç½®æ¥å®ç°ã€‚
ä¾‹å¦‚ï¼Œä¿®æ”¹ order-service çš„ application.yml æ–‡ä»¶ï¼š
```
spring:
   cloud:
      nacos:
        server-addr: 127.0.0.1:8848
        discovery:
          cluster-name: BJ
          namespace: 123 #å‘½åç©ºé—´å
```
é‡å¯ order-service åï¼Œè®¿é—®æ§åˆ¶å°ã€‚
**public**
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561759448-f88452e4-63d1-4df1-95f3-598fa4ec8e57.png#averageHue=%23cac2b5&clientId=ue42b8c5c-255d-4&from=paste&id=uc443393f&originHeight=215&originWidth=572&originalType=url&ratio=1&rotation=0&showTitle=false&size=34144&status=done&style=none&taskId=ud5a6bcb3-c995-4353-9e0d-313895604da&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092143.png)
**dev**
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561760998-7d2f5229-17b6-4a9b-bd61-62a6872f918d.png#averageHue=%23f4f4f3&clientId=ue42b8c5c-255d-4&from=paste&id=u753c97ee&originHeight=214&originWidth=529&originalType=url&ratio=1&rotation=0&showTitle=false&size=34882&status=done&style=none&taskId=ub0ad4459-09a6-41ba-9e47-4d2ccf47040&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092130.png)
æ­¤æ—¶è®¿é—® order-serviceï¼Œå› ä¸º namespace ä¸åŒï¼Œä¼šå¯¼è‡´æ‰¾ä¸åˆ° userserviceï¼Œæ§åˆ¶å°ä¼šæŠ¥é”™ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561766520-a6331b8c-391c-4261-9cb9-43210cdeeca4.png#averageHue=%23eabf0a&clientId=ue42b8c5c-255d-4&from=paste&id=uc590ed6a&originHeight=149&originWidth=995&originalType=url&ratio=1&rotation=0&showTitle=false&size=133637&status=done&style=none&taskId=u76888400-c5b5-4a64-b6b1-5cefa75a0fb&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092138.png)
## ä¸´æ—¶å®ä¾‹
Nacosä¼šä¸»åŠ¨æ¨é€ç»™æ¶ˆè´¹è€…ï¼šæœåŠ¡æ˜¯å¦å®•æœº
Nacos çš„æœåŠ¡å®ä¾‹åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š

- **ä¸´æ—¶å®ä¾‹**ï¼šå¦‚æœå®ä¾‹å®•æœºè¶…è¿‡ä¸€å®šæ—¶é—´ï¼Œä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œ**é»˜è®¤çš„ç±»å‹**ã€‚
- éä¸´æ—¶å®ä¾‹ï¼šå¦‚æœå®ä¾‹å®•æœºï¼Œä¸ä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œä¹Ÿå¯ä»¥å«æ°¸ä¹…å®ä¾‹ã€‚

é…ç½®ä¸€ä¸ªæœåŠ¡å®ä¾‹ä¸ºæ°¸ä¹…å®ä¾‹ï¼š
spring:   cloud:     nacos:       discovery:         ephemeral: false _# è®¾ç½®ä¸ºéä¸´æ—¶å®ä¾‹_
å¦å¤–ï¼ŒNacos é›†ç¾¤**é»˜è®¤é‡‡ç”¨APæ–¹å¼(å¯ç”¨æ€§)**ï¼Œå½“é›†ç¾¤ä¸­å­˜åœ¨éä¸´æ—¶å®ä¾‹æ—¶ï¼Œ**é‡‡ç”¨CPæ¨¡å¼(ä¸€è‡´æ€§)**ï¼›è€Œ Eureka é‡‡ç”¨APæ–¹å¼ï¼Œä¸å¯åˆ‡æ¢ã€‚ï¼ˆè¿™é‡Œè¯´çš„æ˜¯ CAP åŸç†ï¼Œåé¢ä¼šå†™åˆ°ï¼‰
# Nacosé…ç½®ä¸­å¿ƒ
æ¡ˆä¾‹åœ°å€ï¼š[https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos](https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos)
Nacosé™¤äº†å¯ä»¥åšæ³¨å†Œä¸­å¿ƒï¼ŒåŒæ ·å¯ä»¥åšé…ç½®ç®¡ç†æ¥ä½¿ç”¨ã€‚
å½“å¾®æœåŠ¡éƒ¨ç½²çš„å®ä¾‹è¶Šæ¥è¶Šå¤šï¼Œè¾¾åˆ°æ•°åã€æ•°ç™¾æ—¶ï¼Œé€ä¸ªä¿®æ”¹å¾®æœåŠ¡é…ç½®å°±ä¼šè®©äººæŠ“ç‹‚ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å‡ºé”™ã€‚**æˆ‘ä»¬éœ€è¦ä¸€ç§ç»Ÿä¸€é…ç½®ç®¡ç†æ–¹æ¡ˆï¼Œå¯ä»¥é›†ä¸­ç®¡ç†æ‰€æœ‰å®ä¾‹çš„é…ç½®ã€‚**
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561763006-512f708d-d86b-46f3-beba-bea748d8ce5b.png#averageHue=%23fcfcfc&clientId=ue42b8c5c-255d-4&from=paste&id=ud3ca98ec&originHeight=398&originWidth=948&originalType=url&ratio=1&rotation=0&showTitle=false&size=35504&status=done&style=none&taskId=u8f60c035-210e-445d-99ee-56c535158a1&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092150.png)
Nacos ä¸€æ–¹é¢å¯ä»¥å°†é…ç½®é›†ä¸­ç®¡ç†ï¼Œå¦ä¸€æ–¹å¯ä»¥åœ¨é…ç½®å˜æ›´æ—¶ï¼ŒåŠæ—¶é€šçŸ¥å¾®æœåŠ¡ï¼Œ**å®ç°é…ç½®çš„çƒ­æ›´æ–°ã€‚**
## åˆ›å»ºé…ç½®
åœ¨ Nacos æ§åˆ¶é¢æ¿ä¸­æ·»åŠ é…ç½®æ–‡ä»¶
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561769076-4adfe776-06d7-4a0a-973f-c4f6b1eb0a26.png#averageHue=%23e4cda1&clientId=ue42b8c5c-255d-4&from=paste&id=u014cc982&originHeight=600&originWidth=1466&originalType=url&ratio=1&rotation=0&showTitle=false&size=54389&status=done&style=none&taskId=u15d03145-0bb0-4b3b-b156-e0c205767b0&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092159.png)
ç„¶ååœ¨å¼¹å‡ºçš„è¡¨å•ä¸­ï¼Œå¡«å†™é…ç½®ä¿¡æ¯ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561771489-4d8a9336-5454-43a5-bc63-440666cdebeb.png#averageHue=%23979494&clientId=ue42b8c5c-255d-4&from=paste&id=u9a89d835&originHeight=638&originWidth=983&originalType=url&ratio=1&rotation=0&showTitle=false&size=106196&status=done&style=none&taskId=uf7b0dc6e-540e-44f1-85b0-3bb6379b0c6&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092206.png)
**æ³¨æ„ï¼š**é¡¹ç›®çš„æ ¸å¿ƒé…ç½®ï¼Œéœ€è¦çƒ­æ›´æ–°çš„é…ç½®æ‰æœ‰æ”¾åˆ° nacos ç®¡ç†çš„å¿…è¦ã€‚åŸºæœ¬ä¸ä¼šå˜æ›´çš„ä¸€äº›é…ç½®(ä¾‹å¦‚æ•°æ®åº“è¿æ¥)è¿˜æ˜¯ä¿å­˜åœ¨å¾®æœåŠ¡æœ¬åœ°æ¯”è¾ƒå¥½ã€‚
## æ‹‰å–é…ç½®
é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£ Nacos è¯»å–é…ç½®æ–‡ä»¶çš„ç¯èŠ‚æ˜¯åœ¨å“ªä¸€æ­¥ï¼Œåœ¨æ²¡åŠ å…¥ Nacos é…ç½®ä¹‹å‰ï¼Œè·å–é…ç½®æ˜¯è¿™æ ·ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561773547-a300255b-0d3d-4b7e-ae85-33129056da71.png#averageHue=%23fcfafa&clientId=ue42b8c5c-255d-4&from=paste&id=u073ecdc2&originHeight=405&originWidth=1620&originalType=url&ratio=1&rotation=0&showTitle=false&size=41925&status=done&style=none&taskId=u447acb87-4ed0-4eb0-ae37-af34439bdc5&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092215.png)
åŠ å…¥ Nacos é…ç½®ï¼Œå®ƒçš„è¯»å–æ˜¯åœ¨ application.yml ä¹‹å‰çš„ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561777767-13adbba0-b5d3-482e-9d34-5bad1b1f31c2.png#averageHue=%23fdfbfb&clientId=ue42b8c5c-255d-4&from=paste&id=u1478569b&originHeight=529&originWidth=1604&originalType=url&ratio=1&rotation=0&showTitle=false&size=53966&status=done&style=none&taskId=ua081e881-3d88-45c8-9120-1e9de92988d&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092223.png)
è¿™æ—¶å€™å¦‚æœæŠŠ nacos åœ°å€æ”¾åœ¨ application.yml ä¸­ï¼Œæ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ï¼Œ**Nacos å°±æ— æ³•æ ¹æ®åœ°å€å»è·å–é…ç½®äº†ã€‚**
å› æ­¤ï¼Œnacos åœ°å€å¿…é¡»æ”¾åœ¨ä¼˜å…ˆçº§æœ€é«˜çš„ bootstrap.yml æ–‡ä»¶ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561777876-38e65d0b-a13f-48a1-8d4a-f2069b91fb0a.png#averageHue=%23e6e2e2&clientId=ue42b8c5c-255d-4&from=paste&id=u30423a9b&originHeight=500&originWidth=1519&originalType=url&ratio=1&rotation=0&showTitle=false&size=79122&status=done&style=none&taskId=uf5c4808f-dae5-423a-bf3b-ca927ff6552&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092228.png)
**å¼•å…¥ nacos-config ä¾èµ–**
é¦–å…ˆï¼Œåœ¨ user-service æœåŠ¡ä¸­ï¼Œå¼•å…¥ nacos-config çš„å®¢æˆ·ç«¯ä¾èµ–ï¼š
```xml
<!--nacosé…ç½®ç®¡ç†ä¾èµ–-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```
**æ·»åŠ  bootstrap.yml**
ç„¶åï¼Œåœ¨ user-service ä¸­æ·»åŠ ä¸€ä¸ª bootstrap.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
```
spring:
  application:
    name: userservice
  profiles:
    active: dev #ç¯å¢ƒ
  cloud:
    nacos:
      server-addr: localhost:8848
      config:
        file-extension: yaml #åç¼€å
```
æ ¹æ® spring.cloud.nacos.server-addr è·å– nacosåœ°å€ï¼Œå†æ ¹æ®${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}ä½œä¸ºæ–‡ä»¶idï¼Œæ¥è¯»å–é…ç½®ã€‚
åœ¨è¿™ä¸ªä¾‹å­ä¾‹ä¸­ï¼Œå°±æ˜¯å»è¯»å– userservice-dev.yaml
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561777772-32a19333-2650-4f07-8986-78eb57201702.png#averageHue=%23f4f3f3&clientId=ue42b8c5c-255d-4&from=paste&id=u481081fe&originHeight=373&originWidth=788&originalType=url&ratio=1&rotation=0&showTitle=false&size=47799&status=done&style=none&taskId=u720727b7-1a85-4c3b-9aab-d9b4f686980&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092237.png)
ä½¿ç”¨ä»£ç æ¥éªŒè¯æ˜¯å¦æ‹‰å–æˆåŠŸ
åœ¨ user-service ä¸­çš„ UserController ä¸­æ·»åŠ ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å– pattern.dateformat é…ç½®å¹¶ä½¿ç”¨ï¼š
```java
  @Value("${pattern.dateformat}")
    private String dateformat;


    @RequestMapping("now")
    public String now() {
        return LocalDateTime.now().format(DateTimeFormatter.ofPattern(dateformat));
    }
```
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561778812-47dca81c-38a6-4f92-a07f-aff92b99fafa.png#averageHue=%23f1eed1&clientId=ue42b8c5c-255d-4&from=paste&id=uc66846e7&originHeight=494&originWidth=1038&originalType=url&ratio=1&rotation=0&showTitle=false&size=282313&status=done&style=none&taskId=u771f9023-2ede-445a-b732-fb58287a59e&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092243.png)
å¯åŠ¨æœåŠ¡åï¼Œè®¿é—®ï¼š[http://localhost:8081/user/now](http://localhost:8081/user/now)
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561776998-a5010a8a-9355-455c-9ce5-11fc1b89d4a4.png#averageHue=%23dbbc70&clientId=ue42b8c5c-255d-4&from=paste&id=uc7d738ce&originHeight=189&originWidth=543&originalType=url&ratio=1&rotation=0&showTitle=false&size=14717&status=done&style=none&taskId=uba8d5b01-1be2-443b-ace7-219e36123aa&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092251.png)
## é…ç½®çƒ­æ›´æ–°
æˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„ï¼Œæ˜¯ä¿®æ”¹ nacos ä¸­çš„é…ç½®åï¼Œå¾®æœåŠ¡ä¸­æ— éœ€é‡å¯å³å¯è®©é…ç½®ç”Ÿæ•ˆï¼Œä¹Ÿå°±æ˜¯**é…ç½®çƒ­æ›´æ–°**ã€‚
æœ‰ä¸¤ç§æ–¹å¼ï¼š1. ç”¨ @value è¯»å–é…ç½®æ—¶ï¼Œæ­é… @RefreshScopeï¼›2. ç›´æ¥ç”¨ @ConfigurationProperties è¯»å–é…ç½®
### @RefreshScope
æ–¹å¼ä¸€ï¼šåœ¨ @Value æ³¨å…¥çš„å˜é‡æ‰€åœ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ @RefreshScope
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561782642-83131042-f121-41ad-85a4-bbf395a1b241.png#averageHue=%23f2efd2&clientId=ue42b8c5c-255d-4&from=paste&id=ud9134184&originHeight=417&originWidth=920&originalType=url&ratio=1&rotation=0&showTitle=false&size=214917&status=done&style=none&taskId=u607a36c8-03b6-4cb2-a89e-d20d64de311&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092258.png)
### @ConfigurationProperties
æ–¹å¼äºŒï¼šä½¿ç”¨ @ConfigurationProperties æ³¨è§£è¯»å–é…ç½®æ–‡ä»¶ï¼Œå°±ä¸éœ€è¦åŠ  @RefreshScope æ³¨è§£ã€‚
åœ¨ user-service æœåŠ¡ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª PatternProperties ç±»ï¼Œè¯»å– patterrn.dateformat å±æ€§
```java
@ConfigurationProperties(prefix = "pattern")
@Component
@Data
public class PatternProperties {

    private  String dateformat;
}
```
## é…ç½®å…±äº«
å…¶å®åœ¨æœåŠ¡å¯åŠ¨æ—¶ï¼Œnacos ä¼šè¯»å–å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š

- [spring.application.name]-[spring.profiles.active].yamlï¼Œä¾‹å¦‚ï¼šuserservice-dev.yaml
- [spring.application.name].yamlï¼Œä¾‹å¦‚ï¼šuserservice.yaml

è¿™é‡Œçš„ [spring.application.name].yaml ä¸åŒ…å«ç¯å¢ƒï¼Œ**å› æ­¤å¯ä»¥è¢«å¤šä¸ªç¯å¢ƒå…±äº«**ã€‚
**æ·»åŠ ä¸€ä¸ªç¯å¢ƒå…±äº«é…ç½®**
æˆ‘ä»¬åœ¨ nacos ä¸­æ·»åŠ ä¸€ä¸ª userservice.yaml æ–‡ä»¶ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561780283-fa99c0ab-7a5d-4f83-8ff7-f6efb9d63d40.png#averageHue=%23d4d4d4&clientId=ue42b8c5c-255d-4&from=paste&id=u2c12ca9f&originHeight=443&originWidth=704&originalType=url&ratio=1&rotation=0&showTitle=false&size=23867&status=done&style=none&taskId=u6efc3715-a685-4273-ba7d-7db698d7d14&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092323.png)
**åœ¨ user-service ä¸­è¯»å–å…±äº«é…ç½®**
åœ¨ user-service æœåŠ¡ä¸­ï¼Œä¿®æ”¹ PatternProperties ç±»ï¼Œè¯»å–æ–°æ·»åŠ çš„å±æ€§ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561781153-aba615d6-af56-4609-8ab8-c90dccdf18fb.png#averageHue=%23f4f9f2&clientId=ue42b8c5c-255d-4&from=paste&id=u945fab2a&originHeight=257&originWidth=629&originalType=url&ratio=1&rotation=0&showTitle=false&size=55815&status=done&style=none&taskId=ue576d315-fe4f-4c84-ae61-3661266d62e&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092314.png)
åœ¨ user-service æœåŠ¡ä¸­ï¼Œä¿®æ”¹ UserControllerï¼Œæ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561782079-93be776d-d4ab-4323-a40f-1b5dc911a254.png#averageHue=%23f5f9f3&clientId=ue42b8c5c-255d-4&from=paste&id=ud2dca222&originHeight=470&originWidth=702&originalType=url&ratio=1&rotation=0&showTitle=false&size=88398&status=done&style=none&taskId=u0a6c9ab0-28f2-4b90-83fb-75bc06b6a9b&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092331.png)
**è¿è¡Œä¸¤ä¸ª UserApplicationï¼Œä½¿ç”¨ä¸åŒçš„profile**
ä¿®æ”¹ UserApplication2 è¿™ä¸ªå¯åŠ¨é¡¹ï¼Œæ”¹å˜å…¶profileå€¼ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561782590-453a2f6e-7f48-4315-b208-352d9cab7763.png#averageHue=%23edf0e8&clientId=ue42b8c5c-255d-4&from=paste&id=u7d4d4116&originHeight=273&originWidth=748&originalType=url&ratio=1&rotation=0&showTitle=false&size=45809&status=done&style=none&taskId=u003c0e25-c13b-47eb-b8d1-83459d740fa&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092345.png)
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561784781-275dd59c-be80-4e60-a505-2ccee1575a77.png#averageHue=%23f3f2f2&clientId=ue42b8c5c-255d-4&from=paste&id=u64a62c2c&originHeight=877&originWidth=1067&originalType=url&ratio=1&rotation=0&showTitle=false&size=70817&status=done&style=none&taskId=ub5addb58-748e-4511-9c52-5a61c8e15b5&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092338.png)
è¿™æ ·ï¼ŒUserApplication(8081) ä½¿ç”¨çš„ profile æ˜¯ devï¼ŒUserApplication2(8082) ä½¿ç”¨çš„ profile æ˜¯test
å¯åŠ¨ UserApplication å’Œ UserApplication2
è®¿é—®åœ°å€ï¼š[http://localhost:8081/user/prop](http://localhost:8081/user/prop)ï¼Œç»“æœï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561784787-06da6cde-ed75-498d-9a64-1d91bfedb6f8.png#averageHue=%23fafaf9&clientId=ue42b8c5c-255d-4&from=paste&id=uaaf30213&originHeight=200&originWidth=667&originalType=url&ratio=1&rotation=0&showTitle=false&size=60000&status=done&style=none&taskId=u0c8eb7d2-63c4-44a6-b0e9-88a41a202fc&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092400.png)
è®¿é—®åœ°å€ï¼š[http://localhost:8082/user/prop](http://localhost:8082/user/prop)ï¼Œç»“æœï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561785109-9fbbfff3-35e9-4bab-a08e-ae93c1cd176d.png#averageHue=%23fcfbfb&clientId=ue42b8c5c-255d-4&from=paste&id=u7f3e9146&originHeight=207&originWidth=667&originalType=url&ratio=1&rotation=0&showTitle=false&size=45758&status=done&style=none&taskId=u902a395b-3d93-4d60-bcea-ff67b5b21b3&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092419.png)
å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸ç®¡æ˜¯ devï¼Œè¿˜æ˜¯ test ç¯å¢ƒï¼Œéƒ½è¯»å–åˆ°äº† envSharedValue è¿™ä¸ªå±æ€§çš„å€¼ã€‚
ä¸Šé¢çš„éƒ½æ˜¯åŒä¸€ä¸ªå¾®æœåŠ¡ä¸‹ï¼Œ**é‚£ä¹ˆä¸åŒå¾®æœåŠ¡ä¹‹é—´å¯ä»¥ç¯å¢ƒå…±äº«å—ï¼Ÿ**
é€šè¿‡ä¸‹é¢çš„ä¸¤ç§æ–¹å¼æ¥æŒ‡å®šï¼š

- extension-configs
- shared-configs

spring:    cloud:     nacos:       config:         file-extension: yaml _# æ–‡ä»¶åç¼€å_         extends-configs: _# å¤šå¾®æœåŠ¡é—´å…±äº«çš„é…ç½®åˆ—è¡¨_           - dataId: common.yaml _# è¦å…±äº«çš„é…ç½®æ–‡ä»¶id_
spring:    cloud:     nacos:       config:         file-extension: yaml _# æ–‡ä»¶åç¼€å_         shared-configs: _# å¤šå¾®æœåŠ¡é—´å…±äº«çš„é…ç½®åˆ—è¡¨_           - dataId: common.yaml _# è¦å…±äº«çš„é…ç½®æ–‡ä»¶id_
## é…ç½®ä¼˜å…ˆçº§
å½“ nacosã€æœåŠ¡æœ¬åœ°åŒæ—¶**å‡ºç°ç›¸åŒå±æ€§æ—¶**ï¼Œä¼˜å…ˆçº§æœ‰é«˜ä½ä¹‹åˆ†ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561786130-799f5905-9b94-4a94-98ce-885dd6c4b0fb.png#averageHue=%23f1d2b8&clientId=ue42b8c5c-255d-4&from=paste&id=u5b4eae1a&originHeight=267&originWidth=607&originalType=url&ratio=1&rotation=0&showTitle=false&size=26040&status=done&style=none&taskId=u87aed0b5-5656-4a02-9792-f0af5509d02&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092501.png)
æ›´ç»†è‡´çš„é…ç½®
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561786580-cb7e555b-3cc6-4a32-abae-3c17d918a037.png#averageHue=%23f8e4d4&clientId=ue42b8c5c-255d-4&from=paste&id=u214c1faa&originHeight=715&originWidth=1484&originalType=url&ratio=1&rotation=0&showTitle=false&size=115044&status=done&style=none&taskId=uf3605139-eb18-411b-91f1-f62d8f939be&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092520.png)
# Feignè¿œç¨‹è°ƒç”¨
æ¡ˆä¾‹åœ°å€ï¼š[https://gitee.com/xn2001/cloudcode/tree/master/06-cloud-feign](https://gitee.com/xn2001/cloudcode/tree/master/06-cloud-feign)
æˆ‘ä»¬ä»¥å‰åˆ©ç”¨ RestTemplate å‘èµ·è¿œç¨‹è°ƒç”¨çš„ä»£ç ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561787969-2f50aad7-241a-4617-92c8-b7547b82eafd.png#averageHue=%23e6f1e1&clientId=ue42b8c5c-255d-4&from=paste&id=u88137148&originHeight=96&originWidth=973&originalType=url&ratio=1&rotation=0&showTitle=false&size=15517&status=done&style=none&taskId=u6deb9dea-d418-4e4c-8247-d73fb1e3de3&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092616.png)

- ä»£ç å¯è¯»æ€§å·®ï¼Œç¼–ç¨‹ä½“éªŒä¸ç»Ÿä¸€
- å‚æ•°å¤æ‚URLéš¾ä»¥ç»´æŠ¤

Feign æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„ http å®¢æˆ·ç«¯ï¼Œå®˜æ–¹åœ°å€ï¼š[https://github.com/OpenFeign/feign](https://github.com/OpenFeign/feign)
å…¶ä½œç”¨å°±æ˜¯å¸®åŠ©æˆ‘ä»¬**ä¼˜é›…çš„å®ç° http è¯·æ±‚çš„å‘é€**ï¼Œè§£å†³ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561789662-3daaecc4-4c98-4492-8654-1bca918408d4.png#averageHue=%23f5f5f4&clientId=ue42b8c5c-255d-4&from=paste&id=ue2e2171b&originHeight=293&originWidth=1113&originalType=url&ratio=1&rotation=0&showTitle=false&size=120005&status=done&style=none&taskId=ua78a3ec8-f250-4d88-8ba8-132b25704a6&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092639.png)
## Feignä½¿ç”¨
**å¼•å…¥ä¾èµ–**
æˆ‘ä»¬åœ¨ order-service å¼•å…¥ feign ä¾èµ–ï¼š
```xml
 <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```
**æ·»åŠ æ³¨è§£**
åœ¨ order-service å¯åŠ¨ç±»æ·»åŠ æ³¨è§£å¼€å¯ Feign
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561790796-c168788e-24e5-4684-bcde-b52de4ba7cb0.png#averageHue=%23c2c57e&clientId=ue42b8c5c-255d-4&from=paste&id=ud3b91238&originHeight=278&originWidth=683&originalType=url&ratio=1&rotation=0&showTitle=false&size=114631&status=done&style=none&taskId=u1d81c4c3-c13d-4c98-96e9-c1de2a6d854&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092704.png)
**è¯·æ±‚æ¥å£**
åœ¨ order-service ä¸­æ–°å»ºä¸€ä¸ªæ¥å£ï¼Œå†…å®¹å¦‚ä¸‹
```java
@FeignClient("userservice")
public interface OrderClient {
    
    @GetMapping("user/now")
    String now();
    
    @GetMapping("user/now2")
    String now2() ;
    
    @RequestMapping("user/{id}")
    User queryById(@PathVariable("id") Long id);
    //å¸¦å‚æ•°æ—¶æ³¨è§£@RequestParam
}
```
@FeignClient("userservice")ï¼šå…¶ä¸­å‚æ•°å¡«å†™çš„æ˜¯å¾®æœåŠ¡å
@GetMapping("/user/{id}")ï¼šå…¶ä¸­å‚æ•°å¡«å†™çš„æ˜¯è¯·æ±‚è·¯å¾„
è¿™ä¸ªå®¢æˆ·ç«¯ä¸»è¦æ˜¯åŸºäº SpringMVC çš„æ³¨è§£ @GetMapping æ¥å£°æ˜è¿œç¨‹è°ƒç”¨çš„ä¿¡æ¯
Feign å¯ä»¥å¸®åŠ©æˆ‘ä»¬å‘é€ http è¯·æ±‚ï¼Œæ— éœ€è‡ªå·±ä½¿ç”¨ RestTemplate æ¥å‘é€äº†ã€‚
**æµ‹è¯•**
```java
    @Autowired
    private OrderClient orderClient;

    public Order queryOrderById(Long orderId) {
        // 1.æŸ¥è¯¢è®¢å•
        Order order = orderMapper.findById(orderId);
       /* String url = "http://userservice/user/" + order.getUserId();

        User user = restTemplate.getForObject(url, User.class);*/
        User user = orderClient.queryById(order.getUserId());

        order.setUser(user);
        // 4.è¿”å›
        return order;
    }
```
## è‡ªå®šä¹‰é…ç½®
Feign å¯ä»¥æ”¯æŒå¾ˆå¤šçš„è‡ªå®šä¹‰é…ç½®ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

| **ç±»å‹** | **ä½œç”¨** | **è¯´æ˜** |
| --- | --- | --- |
| **feign.Logger.Level** | ä¿®æ”¹æ—¥å¿—çº§åˆ« | åŒ…å«å››ç§ä¸åŒçš„çº§åˆ«ï¼šNONEã€BASICã€HEADERSã€FULL |
| feign.codec.Decoder | å“åº”ç»“æœçš„è§£æå™¨ | httpè¿œç¨‹è°ƒç”¨çš„ç»“æœåšè§£æï¼Œä¾‹å¦‚è§£æjsonå­—ç¬¦ä¸²ä¸ºjavaå¯¹è±¡ |
| feign.codec.Encoder | è¯·æ±‚å‚æ•°ç¼–ç  | å°†è¯·æ±‚å‚æ•°ç¼–ç ï¼Œä¾¿äºé€šè¿‡httpè¯·æ±‚å‘é€ |
| feign.Contract | æ”¯æŒçš„æ³¨è§£æ ¼å¼ | é»˜è®¤æ˜¯SpringMVCçš„æ³¨è§£ |
| feign.Retryer | å¤±è´¥é‡è¯•æœºåˆ¶ | è¯·æ±‚å¤±è´¥çš„é‡è¯•æœºåˆ¶ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰ï¼Œä¸è¿‡ä¼šä½¿ç”¨Ribbonçš„é‡è¯• |

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé»˜è®¤å€¼å°±èƒ½æ»¡è¶³æˆ‘ä»¬ä½¿ç”¨ï¼Œå¦‚æœè¦è‡ªå®šä¹‰æ—¶ï¼Œåªéœ€è¦åˆ›å»ºè‡ªå®šä¹‰çš„ @Bean è¦†ç›–é»˜è®¤ Bean å³å¯ã€‚ä¸‹é¢ä»¥æ—¥å¿—ä¸ºä¾‹æ¥æ¼”ç¤ºå¦‚ä½•è‡ªå®šä¹‰é…ç½®ã€‚
åŸºäºé…ç½®æ–‡ä»¶ä¿®æ”¹ feign çš„æ—¥å¿—çº§åˆ«å¯ä»¥é’ˆå¯¹å•ä¸ªæœåŠ¡ï¼š
```
feign:
  client:
    config:
      default:  # é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®  
        loggerLevel: FULL  #  æ—¥å¿—çº§åˆ« 
```
**ä¹Ÿå¯ä»¥é’ˆå¯¹æ‰€æœ‰æœåŠ¡ï¼š**
```
feign:
  client:
    config:
      default: # è¿™é‡Œç”¨defaultå°±æ˜¯å…¨å±€é…ç½®ï¼Œå¦‚æœæ˜¯å†™æœåŠ¡åç§°ï¼Œåˆ™æ˜¯é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®
        loggerLevel: FULL  #  æ—¥å¿—çº§åˆ« 
```
è€Œæ—¥å¿—çš„çº§åˆ«åˆ†ä¸ºå››ç§ï¼š

- NONEï¼šä¸è®°å½•ä»»ä½•æ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ˜¯é»˜è®¤å€¼ã€‚
- BASICï¼šä»…è®°å½•è¯·æ±‚çš„æ–¹æ³•ï¼ŒURLä»¥åŠå“åº”çŠ¶æ€ç å’Œæ‰§è¡Œæ—¶é—´
- HEADERSï¼šåœ¨BASICçš„åŸºç¡€ä¸Šï¼Œé¢å¤–è®°å½•äº†è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯
- FULLï¼šè®°å½•æ‰€æœ‰è¯·æ±‚å’Œå“åº”çš„æ˜ç»†ï¼ŒåŒ…æ‹¬å¤´ä¿¡æ¯ã€è¯·æ±‚ä½“ã€å…ƒæ•°æ®

ä¹Ÿå¯ä»¥åŸºäº **Java ä»£ç **æ¥ä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼Œå…ˆå£°æ˜ä¸€ä¸ªç±»ï¼Œç„¶åå£°æ˜ä¸€ä¸ª Logger.Level çš„å¯¹è±¡
```java
public class DefaultFeignConfiguration {
    @Bean
    public Logger.Level feignLogLevel() {
        return Logger.Level.BASIC; // æ—¥å¿—çº§åˆ«ä¸ºBASIC 
    }
}
```
å¦‚æœè¦**å…¨å±€ç”Ÿæ•ˆ**ï¼Œå°†å…¶æ”¾åˆ°å¯åŠ¨ç±»çš„ @EnableFeignClients è¿™ä¸ªæ³¨è§£ä¸­ï¼š
**@EnableFeignClients(defaultConfiguration = DefaultFeignConfiguration .class)** 
å¦‚æœæ˜¯**å±€éƒ¨ç”Ÿæ•ˆ**ï¼Œåˆ™æŠŠå®ƒæ”¾åˆ°å¯¹åº”çš„ @FeignClient è¿™ä¸ªæ³¨è§£ä¸­ï¼š
**@FeignClient(value = "userservice", configuration = DefaultFeignConfiguration .class)** 
## æ€§èƒ½ä¼˜åŒ–
Feign åº•å±‚å‘èµ· http è¯·æ±‚ï¼Œä¾èµ–äºå…¶å®ƒçš„æ¡†æ¶ã€‚å…¶åº•å±‚å®¢æˆ·ç«¯å®ç°æœ‰ï¼š

- **URLConnection**ï¼šé»˜è®¤å®ç°ï¼Œä¸æ”¯æŒè¿æ¥æ± 
- **Apache HttpClient** ï¼šæ”¯æŒè¿æ¥æ± 
- **OKHttp**ï¼šæ”¯æŒè¿æ¥æ± 

å› æ­¤æé«˜ Feign æ€§èƒ½çš„ä¸»è¦æ‰‹æ®µå°±æ˜¯ä½¿ç”¨**è¿æ¥æ± **ä»£æ›¿é»˜è®¤çš„ URLConnection
å¦å¤–ï¼Œæ—¥å¿—çº§åˆ«åº”è¯¥å°½é‡ç”¨ basic/noneï¼Œå¯ä»¥æœ‰æ•ˆæé«˜æ€§èƒ½ã€‚
**è¿™é‡Œæˆ‘ä»¬ç”¨ Apache çš„HttpClientæ¥æ¼”ç¤ºè¿æ¥æ± ã€‚**
åœ¨ order-service çš„ pom æ–‡ä»¶ä¸­å¼•å…¥ HttpClient ä¾èµ–
```xml
<dependency>
    <groupId>io.github.openfeign</groupId>
    <artifactId>feign-httpclient</artifactId>
 </dependency>
```
**é…ç½®è¿æ¥æ± **
åœ¨ order-service çš„ application.yml ä¸­æ·»åŠ é…ç½®
```
feign:
  client:
    config:
      default:# defaultå…¨å±€çš„é…ç½®  
        loggerLevel: BASIC # æ—¥å¿—çº§åˆ«ï¼ŒBASICå°±æ˜¯åŸºæœ¬çš„è¯·æ±‚å’Œå“åº”ä¿¡æ¯ 
  httpclient:
    enabled: true # å¼€å¯feignå¯¹HttpClientçš„æ”¯æŒ
    max-connections: 200   # æœ€å¤§çš„è¿æ¥æ•° 
    max-connections-per-route: 50  # æ¯ä¸ªè·¯å¾„çš„æœ€å¤§è¿æ¥æ•°
```
åœ¨ FeignClientFactoryBean ä¸­çš„ loadBalance æ–¹æ³•ä¸­æ‰“æ–­ç‚¹
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561790974-b83a046a-7d26-4145-95ef-9b60d9e0dce9.png#averageHue=%23f3f6ee&clientId=ue42b8c5c-255d-4&from=paste&id=uf39b403d&originHeight=386&originWidth=1181&originalType=url&ratio=1&rotation=0&showTitle=false&size=123050&status=done&style=none&taskId=uce27c90f-49e1-46e7-a792-643f6d59cb1&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092729.png)
Debug æ–¹å¼å¯åŠ¨ order-service æœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ clientï¼Œåº•å±‚å°±æ˜¯ HttpClient
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561792103-2a57eb14-27ba-43bc-8a61-ea37d5956202.png#averageHue=%23f6fbf3&clientId=ue42b8c5c-255d-4&from=paste&id=udd5ba22f&originHeight=285&originWidth=707&originalType=url&ratio=1&rotation=0&showTitle=false&size=67426&status=done&style=none&taskId=uef29d324-a226-45d4-ab38-f0cc81976f6&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092737.png)
## æœ€ä½³å®è·µ
### ç»§æ‰¿æ–¹å¼
ä¸€æ ·çš„ä»£ç å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥å…±äº«ï¼š
1ï¼‰å®šä¹‰ä¸€ä¸ª API æ¥å£ï¼Œåˆ©ç”¨å®šä¹‰æ–¹æ³•ï¼Œå¹¶åŸºäº SpringMVC æ³¨è§£åšå£°æ˜
2ï¼‰Feign å®¢æˆ·ç«¯ã€Controller éƒ½é›†æˆè¯¥æ¥å£
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561792835-12a18969-5e07-40d2-a558-3f7b06e7c367.png#averageHue=%23e3e9d2&clientId=ue42b8c5c-255d-4&from=paste&id=ue45bf134&originHeight=405&originWidth=1221&originalType=url&ratio=1&rotation=0&showTitle=false&size=48209&status=done&style=none&taskId=ude42e770-5e62-45c1-b7d3-b49fec4f06f&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092803.png)
ä¼˜ç‚¹

- ç®€å•
- å®ç°äº†ä»£ç å…±äº«

ç¼ºç‚¹

- æœåŠ¡æä¾›æ–¹ã€æœåŠ¡æ¶ˆè´¹æ–¹ç´§è€¦åˆ
- å‚æ•°åˆ—è¡¨ä¸­çš„æ³¨è§£æ˜ å°„å¹¶ä¸ä¼šç»§æ‰¿ï¼Œå› æ­¤ Controller ä¸­å¿…é¡»å†æ¬¡å£°æ˜æ–¹æ³•ã€å‚æ•°åˆ—è¡¨ã€æ³¨è§£
### æŠ½å–æ–¹å¼
å°† FeignClient æŠ½å–ä¸ºç‹¬ç«‹æ¨¡å—ï¼Œå¹¶ä¸”æŠŠæ¥å£æœ‰å…³çš„ POJOã€é»˜è®¤çš„ Feign é…ç½®éƒ½æ”¾åˆ°è¿™ä¸ªæ¨¡å—ä¸­ï¼Œæä¾›ç»™æ‰€æœ‰æ¶ˆè´¹è€…ä½¿ç”¨ã€‚
ä¾‹å¦‚ï¼šå°† UserClientã€Userã€Feign çš„é»˜è®¤é…ç½®éƒ½æŠ½å–åˆ°ä¸€ä¸ª feign-api åŒ…ä¸­ï¼Œæ‰€æœ‰å¾®æœåŠ¡å¼•ç”¨è¯¥ä¾èµ–åŒ…ï¼Œå³å¯ç›´æ¥ä½¿ç”¨ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561793849-b0afcd05-dd66-42b8-9ac1-d47f695f6f6c.png#averageHue=%23cecd99&clientId=ue42b8c5c-255d-4&from=paste&id=u1b1fc96b&originHeight=465&originWidth=1383&originalType=url&ratio=1&rotation=0&showTitle=false&size=80910&status=done&style=none&taskId=ua23e49b7-8294-40f9-ba27-a0e83af9bd8&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092811.png)
æ¥ä¸‹æ¥æˆ‘ä»¬å°±ç”¨è¯¥æ–¹æ³•åœ¨ä»£ç ä¸­å®ç°
**é¦–å…ˆåˆ›å»ºä¸€ä¸ª moduleï¼Œå‘½åä¸º feign-api**
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561793961-ac00a32d-fd65-408d-b211-b2bdbba84e6d.png#averageHue=%23f1f1f0&clientId=ue42b8c5c-255d-4&from=paste&id=ubccedd1f&originHeight=220&originWidth=717&originalType=url&ratio=1&rotation=0&showTitle=false&size=10692&status=done&style=none&taskId=ufed8d321-06af-4a6d-9e87-0b872414182&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092835.png)
åœ¨ feign-api ä¸­ç„¶åå¼•å…¥ä¾èµ–
```xml
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
```
order-serviceä¸­çš„ UserClientã€User éƒ½å¤åˆ¶åˆ° feign-api é¡¹ç›®ä¸­
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561794876-df4787c0-c478-48f6-bac8-3f739a6bc9d4.png#averageHue=%23f9f3e3&clientId=ue42b8c5c-255d-4&from=paste&id=ub264762f&originHeight=242&originWidth=345&originalType=url&ratio=1&rotation=0&showTitle=false&size=50258&status=done&style=none&taskId=u1fa7dd70-1958-48eb-8c59-3ac366e7ae5&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092848.png)
**åœ¨order-serviceä¸­ä½¿ç”¨ feign-api**
é¦–å…ˆï¼Œåˆ é™¤ order-service ä¸­çš„ UserClientã€User
åœ¨ order-service ä¸­å¼•å…¥ feign-api
```xml
<dependency>    
  <groupId>com.xn2001.feign</groupId>     
  <artifactId>feign-api</artifactId>     
  <version>1.0</version> 
</dependency>
```
**ä¿®æ”¹æ³¨è§£**
å½“å®šä¹‰çš„ FeignClient ä¸åœ¨ SpringBootApplication çš„æ‰«æåŒ…èŒƒå›´ä¸‹æ—¶ï¼Œè¿™äº› FeignClient å°±ä¸èƒ½ä½¿ç”¨ã€‚
ä¿®æ”¹ order-service å¯åŠ¨ç±»ä¸Šçš„ @EnableFeignClients æ³¨è§£
**@EnableFeignClients(basePackages = "com.xn2001.feign.clients") æˆ–è€…**
**@EnableFeignClients(clients={XXXClient.Class})**
# Gatewayç½‘å…³
æ¡ˆä¾‹åœ°å€ï¼š[https://gitee.com/xn2001/cloudcode/tree/master/07-cloud-gateway](https://gitee.com/xn2001/cloudcode/tree/master/07-cloud-gateway)
Spring Cloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäº Spring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰å“åº”å¼ç¼–ç¨‹å’Œäº‹ä»¶æµæŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚
Gateway ç½‘å…³æ˜¯æˆ‘ä»¬æœåŠ¡çš„å®ˆé—¨ç¥ï¼Œ**æ‰€æœ‰å¾®æœåŠ¡çš„ç»Ÿä¸€å…¥å£ã€‚**
ç½‘å…³çš„**æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§**ï¼š

- è¯·æ±‚è·¯ç”±
- æƒé™æ§åˆ¶
- é™æµ

[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561797473-c0eb161e-1423-4eb7-800f-9e16612547a5.png#averageHue=%23fbf6f6&clientId=ue42b8c5c-255d-4&from=paste&id=uf4439108&originHeight=669&originWidth=1378&originalType=url&ratio=1&rotation=0&showTitle=false&size=109468&status=done&style=none&taskId=u69706e1d-25f1-44e2-b821-a35bf6a54e7&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/20210901092857.png)
**æƒé™æ§åˆ¶**ï¼šç½‘å…³ä½œä¸ºå¾®æœåŠ¡å…¥å£ï¼Œéœ€è¦æ ¡éªŒç”¨æˆ·æ˜¯æ˜¯å¦æœ‰è¯·æ±‚èµ„æ ¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›è¡Œæ‹¦æˆªã€‚
**è·¯ç”±å’Œè´Ÿè½½å‡è¡¡**ï¼šä¸€åˆ‡è¯·æ±‚éƒ½å¿…é¡»å…ˆç»è¿‡ gatewayï¼Œä½†ç½‘å…³ä¸å¤„ç†ä¸šåŠ¡ï¼Œè€Œæ˜¯æ ¹æ®æŸç§è§„åˆ™ï¼ŒæŠŠè¯·æ±‚è½¬å‘åˆ°æŸä¸ªå¾®æœåŠ¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšè·¯ç”±ã€‚å½“ç„¶è·¯ç”±çš„ç›®æ ‡æœåŠ¡æœ‰å¤šä¸ªæ—¶ï¼Œè¿˜éœ€è¦åšè´Ÿè½½å‡è¡¡ã€‚
**é™æµ**ï¼šå½“è¯·æ±‚æµé‡è¿‡é«˜æ—¶ï¼Œåœ¨ç½‘å…³ä¸­æŒ‰ç…§ä¸‹æµçš„å¾®æœåŠ¡èƒ½å¤Ÿæ¥å—çš„é€Ÿåº¦æ¥æ”¾è¡Œè¯·æ±‚ï¼Œé¿å…æœåŠ¡å‹åŠ›è¿‡å¤§ã€‚
åœ¨ SpringCloud ä¸­ç½‘å…³çš„å®ç°åŒ…æ‹¬ä¸¤ç§ï¼š

- gateway
- zuul

Zuul æ˜¯åŸºäº Servlet å®ç°ï¼Œå±äºé˜»å¡å¼ç¼–ç¨‹ã€‚è€Œ Spring Cloud Gateway åˆ™æ˜¯åŸºäº Spring5 ä¸­æä¾›çš„WebFluxï¼Œå±äºå“åº”å¼ç¼–ç¨‹çš„å®ç°ï¼Œå…·å¤‡æ›´å¥½çš„æ€§èƒ½ã€‚
## å…¥é—¨ä½¿ç”¨

1. åˆ›å»º SpringBoot å·¥ç¨‹ gatewayï¼Œå¼•å…¥ç½‘å…³ä¾èµ–
2. ç¼–å†™å¯åŠ¨ç±»
3. ç¼–å†™åŸºç¡€é…ç½®å’Œè·¯ç”±è§„åˆ™
4. å¯åŠ¨ç½‘å…³æœåŠ¡è¿›è¡Œæµ‹è¯•
```xml
<!--ç½‘å…³--> 
<dependency>
     <groupId>org.springframework.cloud</groupId>
     <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
 <!--nacosæœåŠ¡å‘ç°ä¾èµ–-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```
åˆ›å»º application.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
```yaml
server:
  port: 8004
spring:
  application:
    name: gateway
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848
    gateway:
      routes:
        - id: user-service # è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯
          # uri: http://127.0.0.1:8081 # è·¯ç”±çš„ç›®æ ‡åœ°å€ httpå°±æ˜¯å›ºå®šåœ°å€
          uri: lb://userservice # è·¯ç”±çš„ç›®æ ‡åœ°å€ lbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåé¢è·ŸæœåŠ¡åç§°
          predicates: # è·¯ç”±æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶
            - Path=/user/** # è¿™ä¸ªæ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œåªè¦ä»¥/user/å¼€å¤´å°±ç¬¦åˆè¦æ±‚
```
æˆ‘ä»¬å°†ç¬¦åˆPath è§„åˆ™çš„ä¸€åˆ‡è¯·æ±‚ï¼Œéƒ½ä»£ç†åˆ° uriå‚æ•°æŒ‡å®šçš„åœ°å€ã€‚
ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°† /user/** å¼€å¤´çš„è¯·æ±‚ï¼Œä»£ç†åˆ° lb://userserviceï¼Œå…¶ä¸­ lb æ˜¯è´Ÿè½½å‡è¡¡(LoadBalance)ï¼Œæ ¹æ®æœåŠ¡åæ‹‰å–æœåŠ¡åˆ—è¡¨ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚
é‡å¯ç½‘å…³ï¼Œè®¿é—® [http://localhost:10010/user/1](http://localhost:10010/user/1) æ—¶ï¼Œç¬¦åˆ /user/** è§„åˆ™ï¼Œè¯·æ±‚è½¬å‘åˆ° uriï¼š[http://userservice/user/1](http://userservice/user/1)
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561796086-afc736c3-203b-45d5-a7a3-d4ec82db8f24.png#averageHue=%23fcfcfc&clientId=ue42b8c5c-255d-4&from=paste&id=u41bc4081&originHeight=215&originWidth=445&originalType=url&ratio=1&rotation=0&showTitle=false&size=35340&status=done&style=none&taskId=u93076595-667a-41b0-94f5-1ed23e96408&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/202108220125749.png)
å¤šä¸ª predicates çš„è¯ï¼Œè¦åŒæ—¶æ»¡è¶³è§„åˆ™ï¼Œä¸‹æ–‡æœ‰ä¾‹å­ã€‚
## æµç¨‹å›¾
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561798436-211548cf-e871-4799-a8e1-0427bcd89e4f.png#averageHue=%23f7efef&clientId=ue42b8c5c-255d-4&from=paste&id=u1409b31d&originHeight=635&originWidth=1281&originalType=url&ratio=1&rotation=0&showTitle=false&size=96201&status=done&style=none&taskId=uce730abc-ee59-4c3c-b637-f251c74ed69&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/202108220127419.png)
è·¯ç”±é…ç½®åŒ…æ‹¬ï¼š

1. è·¯ç”±idï¼šè·¯ç”±çš„å”¯ä¸€æ ‡ç¤º
2. è·¯ç”±ç›®æ ‡ï¼ˆuriï¼‰ï¼šè·¯ç”±çš„ç›®æ ‡åœ°å€ï¼Œhttpä»£è¡¨å›ºå®šåœ°å€ï¼Œlbä»£è¡¨æ ¹æ®æœåŠ¡åè´Ÿè½½å‡è¡¡
3. è·¯ç”±æ–­è¨€ï¼ˆpredicatesï¼‰ï¼šåˆ¤æ–­è·¯ç”±çš„è§„åˆ™
4. è·¯ç”±è¿‡æ»¤å™¨ï¼ˆfiltersï¼‰ï¼šå¯¹è¯·æ±‚æˆ–å“åº”åšå¤„ç†
## æ–­è¨€å·¥å‚
æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å†™çš„æ–­è¨€è§„åˆ™åªæ˜¯å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä¼šè¢« Predicate Factory è¯»å–å¹¶å¤„ç†ï¼Œè½¬å˜ä¸ºè·¯ç”±åˆ¤æ–­çš„æ¡ä»¶ã€‚
ä¾‹å¦‚ Path=/user/** æ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œè¿™ä¸ªè§„åˆ™æ˜¯ç”±
org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory ç±»æ¥å¤„ç†çš„ï¼Œåƒè¿™æ ·çš„æ–­è¨€å·¥å‚åœ¨ Spring Cloud Gateway è¿˜æœ‰åå‡ ä¸ª

| **åç§°** | **è¯´æ˜** | **ç¤ºä¾‹** |
| --- | --- | --- |
| After | æ˜¯æŸä¸ªæ—¶é—´ç‚¹åçš„è¯·æ±‚ | - After=2037-01-20T17:42:47.789-07:00[America/Denver] |
| Before | æ˜¯æŸä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚ | - Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai] |
| Between | æ˜¯æŸä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚ | - Between=2037-01-20T17:42:47.789-07:00[America/Denver], 2037-01-21T17:42:47.789-07:00[America/Denver] |
| Cookie | è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›cookie | - Cookie=chocolate, ch.p |
| Header | è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›header | - Header=X-Request-Id, \\d+ |
| Host | è¯·æ±‚å¿…é¡»æ˜¯è®¿é—®æŸä¸ªhostï¼ˆåŸŸåï¼‰ | - Host=**.somehost.org, **.anotherhost.org |
| Method | è¯·æ±‚æ–¹å¼å¿…é¡»æ˜¯æŒ‡å®šæ–¹å¼ | - Method=GET,POST |
| Path | è¯·æ±‚è·¯å¾„å¿…é¡»ç¬¦åˆæŒ‡å®šè§„åˆ™ | - Path=/red/{segment},/blue/** |
| Query | è¯·æ±‚å‚æ•°å¿…é¡»åŒ…å«æŒ‡å®šå‚æ•° | - Query=name, Jackæˆ–è€…- Query=name |
| RemoteAddr | è¯·æ±‚è€…çš„ipå¿…é¡»æ˜¯æŒ‡å®šèŒƒå›´ | - RemoteAddr=192.168.1.1/24 |
| Weight | æƒé‡å¤„ç† |  |

å®˜æ–¹æ–‡æ¡£ï¼š[https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories)
ä¸€èˆ¬çš„ï¼Œæˆ‘ä»¬åªéœ€è¦æŒæ¡ Pathï¼ŒåŠ ä¸Šå®˜æ–¹æ–‡æ¡£çš„ä¾‹å­ï¼Œå°±å¯ä»¥åº”å¯¹å„ç§å·¥ä½œåœºæ™¯äº†ã€‚
predicates:   - Path=/order/**   - After=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]
åƒè¿™æ ·çš„è§„åˆ™ï¼Œç°åœ¨æ˜¯ 2021å¹´8æœˆ22æ—¥01:32:42ï¼Œå¾ˆæ˜æ˜¾ After æ¡ä»¶ä¸æ»¡è¶³ï¼Œå¯ä»¥ä¸ä¼šè½¬å‘ï¼Œè·¯ç”±ä¸èµ·ä½œç”¨ã€‚
## è¿‡æ»¤å™¨å·¥å‚
GatewayFilter æ˜¯ç½‘å…³ä¸­æä¾›çš„ä¸€ç§è¿‡æ»¤å™¨ï¼Œå¯ä»¥å¯¹è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡è¿”å›çš„å“åº”åšå¤„ç†ã€‚
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561798466-d6e7c908-cc3f-49ad-b6ce-7558e22e39ae.png#averageHue=%23fdecec&clientId=ue42b8c5c-255d-4&from=paste&id=u9acd8938&originHeight=415&originWidth=1129&originalType=url&ratio=1&rotation=0&showTitle=false&size=69486&status=done&style=none&taskId=u67476529-7d28-4b1b-89ce-e120f7a1bd6&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/202108220133487.png)
Springæä¾›äº†31ç§ä¸åŒçš„è·¯ç”±è¿‡æ»¤å™¨å·¥å‚ã€‚
å®˜æ–¹æ–‡æ¡£ï¼š[https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories)

| **åç§°** | **è¯´æ˜** |
| --- | --- |
| AddRequestHeader | ç»™å½“å‰è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´ |
| RemoveRequestHeader | ç§»é™¤è¯·æ±‚ä¸­çš„ä¸€ä¸ªè¯·æ±‚å¤´ |
| AddResponseHeader | ç»™å“åº”ç»“æœä¸­æ·»åŠ ä¸€ä¸ªå“åº”å¤´ |
| RemoveResponseHeader | ä»å“åº”ç»“æœä¸­ç§»é™¤æœ‰ä¸€ä¸ªå“åº”å¤´ |
| RequestRateLimiter | é™åˆ¶è¯·æ±‚çš„æµé‡ |

ä¸‹é¢æˆ‘ä»¬ä»¥ AddRequestHeader ä¸ºä¾‹ï¼š
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561798353-3866a209-ce8e-424a-bdd0-c8a22cf8e105.png#averageHue=%23fbfafa&clientId=ue42b8c5c-255d-4&from=paste&id=u4f92a9ac&originHeight=392&originWidth=991&originalType=url&ratio=1&rotation=0&showTitle=false&size=26423&status=done&style=none&taskId=uc559e54f-e9e5-4082-ba74-66313fdeab5&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/202108220139913.png)
**éœ€æ±‚**ï¼šç»™æ‰€æœ‰è¿›å…¥ userservice çš„è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´ï¼šsign=xn2001.com is eternal
åªéœ€è¦ä¿®æ”¹ gateway æœåŠ¡çš„ application.ymlæ–‡ä»¶ï¼Œæ·»åŠ è·¯ç”±è¿‡æ»¤å³å¯ã€‚
```yaml
server:
  port: 8004
spring:
  application:
    name: gateway
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848
    gateway:
      routes:
        - id: user-service # è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯
          # uri: http://127.0.0.1:8081 # è·¯ç”±çš„ç›®æ ‡åœ°å€ httpå°±æ˜¯å›ºå®šåœ°å€
          uri: lb://userservice # è·¯ç”±çš„ç›®æ ‡åœ°å€ lbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåé¢è·ŸæœåŠ¡åç§°
          predicates: # è·¯ç”±æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶
            - Path=/user/** # è¿™ä¸ªæ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œåªè¦ä»¥/user/å¼€å¤´å°±ç¬¦åˆè¦æ±‚
            - Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]
          filters:
            - AddRequestHeader=sign, xn2001.com is eternal
```
å¦‚ä½•éªŒè¯ï¼Œæˆ‘ä»¬ä¿®æ”¹ userservice ä¸­çš„ä¸€ä¸ªæ¥å£
**@GetMapping("/{id}")** **public** User **queryById**(**@PathVariable("id")** Long id, **@RequestHeader(value = "sign", required = false)** String sign) {     log.warn(sign);     **return** userService.queryById(id); }
é‡å¯ä¸¤ä¸ªæœåŠ¡ï¼Œè®¿é—®ï¼š[http://localhost:10010/user/1](http://localhost:10010/user/1)
å¯ä»¥çœ‹åˆ°æ§åˆ¶å°æ‰“å°å‡ºäº†è¿™ä¸ªè¯·æ±‚å¤´
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561802016-434a7347-9fc8-4945-9983-cd06261e5234.png#averageHue=%23e6e96b&clientId=ue42b8c5c-255d-4&from=paste&id=u3466c7cc&originHeight=230&originWidth=1300&originalType=url&ratio=1&rotation=0&showTitle=false&size=229489&status=done&style=none&taskId=u5fa6b0cf-afdb-4517-b2e7-f3fbbcd36df&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/202108220145565.png)
å½“ç„¶ï¼ŒGateway ä¹Ÿæ˜¯æœ‰**å…¨å±€è¿‡æ»¤å™¨**çš„ï¼Œå¦‚æœè¦**å¯¹æ‰€æœ‰çš„è·¯ç”±éƒ½ç”Ÿæ•ˆ**ï¼Œåˆ™å¯ä»¥å°†è¿‡æ»¤å™¨å·¥å‚å†™åˆ° default-filters ä¸‹ï¼š

```yaml
spring:    
  cloud:     
    gateway:       
      default-filters:         
        - AddRequestHeader=sign, xn2001.com is eternal # æ·»åŠ è¯·æ±‚å¤´
```
## å…¨å±€è¿‡æ»¤å™¨
ä¸Šé¢ä»‹ç»çš„è¿‡æ»¤å™¨å·¥å‚ï¼Œç½‘å…³æä¾›äº† 31 ç§ï¼Œä½†æ¯ä¸€ç§è¿‡æ»¤å™¨çš„ä½œç”¨éƒ½æ˜¯å›ºå®šçš„ã€‚**å¦‚æœæˆ‘ä»¬å¸Œæœ›æ‹¦æˆªè¯·æ±‚ï¼Œåšè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘åˆ™æ²¡åŠæ³•å®ç°**ã€‚
å…¨å±€è¿‡æ»¤å™¨çš„ä½œç”¨ä¹Ÿæ˜¯å¤„ç†ä¸€åˆ‡è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡å“åº”ï¼Œ**ä¸ GatewayFilter çš„ä½œç”¨ä¸€æ ·**ã€‚åŒºåˆ«åœ¨äº GlobalFilter çš„é€»è¾‘å¯ä»¥**å†™ä»£ç æ¥è‡ªå®šä¹‰è§„åˆ™**ï¼›è€Œ GatewayFilter é€šè¿‡é…ç½®å®šä¹‰ï¼Œå¤„ç†é€»è¾‘æ˜¯å›ºå®šçš„ã€‚
**éœ€æ±‚ï¼š**å®šä¹‰å…¨å±€è¿‡æ»¤å™¨ï¼Œæ‹¦æˆªè¯·æ±‚ï¼Œåˆ¤æ–­è¯·æ±‚çš„å‚æ•°æ˜¯å¦æ»¡è¶³ä¸‹é¢æ¡ä»¶

- å‚æ•°ä¸­æ˜¯å¦æœ‰ authorization
- authorization å‚æ•°å€¼æ˜¯å¦ä¸º admin

å¦‚æœåŒæ—¶æ»¡è¶³åˆ™æ”¾è¡Œï¼Œå¦åˆ™æ‹¦æˆªã€‚
```java
@Component
@Order(-1)
// è®¾ç½®è¿‡æ»¤å™¨ä¼˜å…ˆçº§ï¼Œå€¼è¶Šä½ä¼˜å…ˆçº§è¶Šé«˜  
public class AuthorizeFilter implements GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        // è·å–ç¬¬ä¸€ä¸ª authorization å‚æ•°  
        String authorization = request.getQueryParams().getFirst("authorization");
        if ("authorization".equals(authorization)){
            
            return chain.filter(exchange);
        }
        
        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
        return exchange.getResponse().setComplete();
    }
}

```
> ç»§æ‰¿order
> **public** **int** **getOrder**() {         **return** 0;     }

## è¿‡æ»¤å™¨é¡ºåº
è¯·æ±‚è¿›å…¥ç½‘å…³ä¼šç¢°åˆ°ä¸‰ç±»è¿‡æ»¤å™¨ï¼šDefaultFilterã€å½“å‰è·¯ç”±çš„è¿‡æ»¤å™¨ã€GlobalFilterï¼›
è¯·æ±‚è·¯ç”±åï¼Œä¼šå°†ä¸‰è€…åˆå¹¶åˆ°ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼ˆé›†åˆï¼‰ä¸­ï¼Œæ’åºåä¾æ¬¡æ‰§è¡Œæ¯ä¸ªè¿‡æ»¤å™¨.
[![image.png](https://cdn.nlark.com/yuque/0/2022/png/26526323/1651561800919-1940a018-7a4a-4197-8329-3e26d93480c2.png#averageHue=%23cfc4c3&clientId=ue42b8c5c-255d-4&from=paste&id=ub1a5ec30&originHeight=475&originWidth=1368&originalType=url&ratio=1&rotation=0&showTitle=false&size=100531&status=done&style=none&taskId=u39c65025-1d21-482a-9d17-46741f03198&title=)](https://cdn.jsdelivr.net/gh/lexinhu/Image/img/2021/202108230002747.png)
æ’åºçš„è§„åˆ™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

- æ¯ä¸€ä¸ªè¿‡æ»¤å™¨éƒ½å¿…é¡»æŒ‡å®šä¸€ä¸ª int ç±»å‹çš„ order å€¼ï¼Œ**order å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ‰§è¡Œé¡ºåºè¶Šé å‰**ã€‚
- GlobalFilter é€šè¿‡å®ç° Ordered æ¥å£ï¼Œæˆ–è€…ä½¿ç”¨ @Order æ³¨è§£æ¥æŒ‡å®š order å€¼ï¼Œç”±æˆ‘ä»¬è‡ªå·±æŒ‡å®šã€‚
- è·¯ç”±è¿‡æ»¤å™¨å’Œ defaultFilter çš„ order ç”± Spring æŒ‡å®šï¼Œé»˜è®¤æ˜¯æŒ‰ç…§å£°æ˜é¡ºåºä»1é€’å¢ã€‚
- å½“è¿‡æ»¤å™¨çš„ order å€¼ä¸€æ ·æ—¶ï¼Œ**ä¼šæŒ‰ç…§ defaultFilter > è·¯ç”±è¿‡æ»¤å™¨ > GlobalFilter çš„é¡ºåºæ‰§è¡Œã€‚**
## è·¨åŸŸé—®é¢˜
ä¸äº†è§£è·¨åŸŸé—®é¢˜çš„åŒå­¦å¯ä»¥ç™¾åº¦äº†è§£ä¸€ä¸‹ï¼›åœ¨ Gateway ç½‘å…³ä¸­è§£å†³è·¨åŸŸé—®é¢˜è¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ã€‚
```yaml
spring:
  cloud:
    gateway:
      globalcors: # å…¨å±€çš„è·¨åŸŸå¤„ç†
        add-to-simple-url-handler-mapping: true # è§£å†³optionsè¯·æ±‚è¢«æ‹¦æˆªé—®é¢˜
        corsConfigurations:
          '[/**]':
            allowedOrigins: # å…è®¸å“ªäº›ç½‘ç«™çš„è·¨åŸŸè¯·æ±‚ allowedOrigins: â€œ*â€ å…è®¸æ‰€æœ‰ç½‘ç«™
              - "http://localhost:8090"
            allowedMethods: # å…è®¸çš„è·¨åŸŸajaxçš„è¯·æ±‚æ–¹å¼
              - "GET"
              - "POST"
              - "DELETE"
              - "PUT"
              - "OPTIONS"
            allowedHeaders: "*" # å…è®¸åœ¨è¯·æ±‚ä¸­æºå¸¦çš„å¤´ä¿¡æ¯
            allowCredentials: true # æ˜¯å¦å…è®¸æºå¸¦cookie
            maxAge: 360000 # è¿™æ¬¡è·¨åŸŸæ£€æµ‹çš„æœ‰æ•ˆæœŸ
```